<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>添加事件</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="i18n.js?v=19.2"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Noto Serif TC", serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-[#f8c390] via-[#f9dba0] to-[#fbf2d3] h-screen flex flex-col text-[#5c4033] selection:bg-[#b35c1e] selection:text-white">

  <!-- Header -->
  <header class="flex justify-between items-center px-4 py-3 bg-white/30 backdrop-blur-xl border-b border-white/30 sticky top-0 z-30 shadow-sm">
    <button onclick="history.back()" class="text-[#8B4513] text-base font-medium hover:opacity-70 transition-opacity flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
        <span data-i18n="event_cancel">取消</span>
    </button>
    <h1 class="text-lg font-bold tracking-wide drop-shadow-sm" id="page-title" data-i18n="add_event_title">新建事件</h1>
    <button onclick="saveEvent()" class="text-[#8B4513] text-base font-bold opacity-50 transition-all bg-white/40 px-3 py-1 rounded-full border border-white/30 hover:bg-white/60 active:scale-95 disabled:active:scale-100" id="save-btn" disabled data-i18n="event_save">保存</button>
  </header>

  <!-- Form -->
  <main class="flex-1 overflow-y-auto p-4">
    <div class="space-y-6 max-w-md mx-auto">
      
      <!-- Title Input -->
      <div class="bg-white/40 backdrop-blur-xl rounded-2xl overflow-hidden shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 focus-within:ring-2 focus-within:ring-[#b35c1e]/20 transition-all">
        <input type="text" id="event-title" placeholder="標題" data-i18n-placeholder="event_title_placeholder" class="w-full p-4 text-lg bg-transparent outline-none text-[#5c4033] placeholder-[#8B4513]/40" oninput="checkForm()">
      </div>

      <!-- Date Time -->
      <div class="bg-white/40 backdrop-blur-xl rounded-2xl overflow-hidden shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 divide-y divide-white/40">
        <div class="flex justify-between items-center p-4 hover:bg-white/30 transition-colors">
          <span class="text-[#8B4513] font-medium" data-i18n="event_all_day">全天</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="all-day" class="sr-only peer" checked onchange="toggleTimeInputs()">
            <div class="w-11 h-6 bg-white/50 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#b35c1e] shadow-inner border border-white/40"></div>
          </label>
        </div>
        
        <div class="flex justify-between items-center p-4 hover:bg-white/30 transition-colors">
          <span class="text-[#8B4513] font-medium" data-i18n="event_start">開始</span>
          <div class="flex gap-2">
             <input type="date" id="start-date" class="bg-transparent text-[#5c4033] outline-none text-right font-medium focus:text-[#b35c1e] transition-colors">
             <input type="time" id="start-time" class="bg-transparent text-[#5c4033] outline-none text-right font-medium focus:text-[#b35c1e] transition-colors hidden">
          </div>
        </div>

        <div class="flex justify-between items-center p-4 hover:bg-white/30 transition-colors">
          <span class="text-[#8B4513] font-medium" data-i18n="event_end">結束</span>
          <div class="flex gap-2">
             <input type="date" id="end-date" class="bg-transparent text-[#5c4033] outline-none text-right font-medium focus:text-[#b35c1e] transition-colors">
             <input type="time" id="end-time" class="bg-transparent text-[#5c4033] outline-none text-right font-medium focus:text-[#b35c1e] transition-colors hidden">
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="bg-white/40 backdrop-blur-xl rounded-2xl overflow-hidden shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 focus-within:ring-2 focus-within:ring-[#b35c1e]/20 transition-all">
        <textarea id="description" rows="6" placeholder="備註" data-i18n-placeholder="event_desc_placeholder" class="w-full p-4 text-base bg-transparent outline-none text-[#5c4033] placeholder-[#8B4513]/40 resize-none"></textarea>
      </div>

      <!-- Delete Button (Hidden by default) -->
      <button onclick="deleteEvent()" id="delete-btn" class="w-full py-4 text-red-500 bg-white/40 backdrop-blur-xl rounded-2xl shadow-sm border border-red-100 font-medium hover:bg-red-50/50 transition-colors hidden" data-i18n="event_delete">
        刪除事件
      </button>

    </div>
  </main>

  <script>
    // Translation Logic
    function applyTranslations() {
      if (typeof t !== 'function') return;
      
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const translation = t(key);
        if (translation) {
          if (el.hasAttribute('data-i18n-html')) {
            el.innerHTML = translation;
          } else {
            el.innerText = translation;
          }
        }
      });
      
      // Update placeholders
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const key = el.getAttribute('data-i18n-placeholder');
          const translation = t(key);
          if(translation) {
              el.placeholder = translation;
          }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
        applyTranslations();
    });

    // Global Event ID
    let currentEventId = null;

    // Initialize Dates
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = dateStr;
    document.getElementById('end-date').value = dateStr;

    // Check for ID in URL
    (function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (id) {
            loadEvent(id);
        }
    })();

    function loadEvent(id) {
        const events = JSON.parse(localStorage.getItem('buddhist_calendar_events') || '[]');
        const event = events.find(e => e.id === id);
        
        if (event) {
            currentEventId = event.id;
            document.getElementById('page-title').innerText = t('edit_event_title');
            document.getElementById('event-title').value = event.title;
            document.getElementById('start-date').value = event.startDate;
            document.getElementById('end-date').value = event.endDate;
            document.getElementById('description').value = event.description || '';
            
            // Handle All Day Checkbox
            const allDayCheckbox = document.getElementById('all-day');
            allDayCheckbox.checked = event.isAllDay;
            
            // Handle Times if not all day (assuming you saved them, if not saved in prev version, default)
            // Note: Previous saveEvent didn't explicitly grab time values if hidden, but let's assume standard behavior
            // For now, toggle inputs correctly
            toggleTimeInputs(); 

            // Show Delete Button
            document.getElementById('delete-btn').classList.remove('hidden');
            
            // Enable Save Button
            checkForm();
        }
    }

    function toggleTimeInputs() {
        const isAllDay = document.getElementById('all-day').checked;
        const start = document.getElementById('start-time');
        const end = document.getElementById('end-time');
        
        if (isAllDay) {
            start.classList.add('hidden');
            end.classList.add('hidden');
        } else {
            start.classList.remove('hidden');
            end.classList.remove('hidden');
            // Set default time if empty
            if(!start.value) start.value = "09:00";
            if(!end.value) end.value = "10:00";
        }
    }

    function checkForm() {
        const title = document.getElementById('event-title').value.trim();
        const btn = document.getElementById('save-btn');
        if (title.length > 0) {
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        } else {
            btn.disabled = true;
            btn.classList.add('opacity-50');
        }
    }

    function saveEvent() {
        const title = document.getElementById('event-title').value.trim();
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const description = document.getElementById('description').value;
        const isAllDay = document.getElementById('all-day').checked;
        
        if (!title || !startDate) return;

        const events = JSON.parse(localStorage.getItem('buddhist_calendar_events') || '[]');
        
        if (currentEventId) {
            // Update existing
            const index = events.findIndex(e => e.id === currentEventId);
            if (index !== -1) {
                events[index] = {
                    ...events[index],
                    title,
                    startDate,
                    endDate,
                    description,
                    isAllDay
                };
            }
        } else {
            // Create new
            const event = {
                id: Date.now().toString(),
                title,
                startDate,
                endDate,
                description,
                isAllDay
            };
            events.push(event);
        }

        localStorage.setItem('buddhist_calendar_events', JSON.stringify(events));

        // alert('事件已保存');
        history.back();
    }

    function deleteEvent() {
        if (!currentEventId) return;
        if (!confirm(t('event_delete_confirm'))) return;

        const events = JSON.parse(localStorage.getItem('buddhist_calendar_events') || '[]');
        const newEvents = events.filter(e => e.id !== currentEventId);
        localStorage.setItem('buddhist_calendar_events', JSON.stringify(newEvents));
        
        history.back();
    }
  </script>
</body>
</html>