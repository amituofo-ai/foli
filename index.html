<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-512.png">
  <title>ä½›å†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- å¼•å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  // Zen Diet Logic
  // recipeData loaded from recipe_data.js

  var COLOR_MAP = {
      white: { bg: 'bg-slate-100', text: 'text-slate-600', dot: 'bg-slate-400', label: 'å…¥è‚ºÂ·ç™½' },
      yellow: { bg: 'bg-amber-100', text: 'text-amber-700', dot: 'bg-amber-400', label: 'å…¥è„¾Â·é»„' },
      red: { bg: 'bg-rose-100', text: 'text-rose-700', dot: 'bg-rose-400', label: 'å…¥å¿ƒÂ·çº¢' },
      green: { bg: 'bg-emerald-100', text: 'text-emerald-700', dot: 'bg-emerald-500', label: 'å…¥è‚Â·ç»¿' },
      black: { bg: 'bg-stone-200', text: 'text-stone-700', dot: 'bg-stone-800', label: 'å…¥è‚¾Â·é»‘' }
  };

</script>
  <script src="lunar.js?v=19.5"></script>
<!-- i18n Definitions -->
  <!-- i18n Definitions -->
  <script src="i18n.js?v=19.4"></script>
  <script src="sutras_data.js?v=19.4"></script>
  <!-- Load Recipe Data -->
  <script src="recipe_data.js?v=19.4"></script>
  <script src="diet_logic.js?v=19.4"></script>
  <script src="video_data.js?v=19.4"></script>
  <script src="audio_data_v13.js"></script>
  <!-- Load Search Data Lazily -->
  <!-- <script src="search_data.js?v=19.4"></script> -->
  <!-- Load AI Chat -->
  <script src="ai_chat.js?v=19.4"></script>
  <script src="events_data.js?v=20.5"></script>
  <script>
    function showTooltip(event, html) {
      const tooltip = document.getElementById('event-tooltip');
      if (!tooltip) return;
      tooltip.innerHTML = html;
      tooltip.style.display = 'block';
      const x = event.clientX + 15;
      const y = event.clientY + 15;
      const tooltipRect = tooltip.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      let left = x;
      if (x + tooltipRect.width > viewportWidth) {
        left = viewportWidth - tooltipRect.width - 15;
      }

      let top = y;
      if (y + tooltipRect.height > viewportHeight) {
        top = viewportHeight - tooltipRect.height - 15;
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
    }

    function hideTooltip() {
      const tooltip = document.getElementById('event-tooltip');
      if (tooltip) tooltip.style.display = 'none';
    }

    function applySpecialEvents(year, month) {
        console.log(`[Debug] applySpecialEvents called for ${year}-${month + 1}`);
        if (!window.events) {
            console.error("[Debug] window.events is not defined. Cannot apply events.");
            return;
        }
        console.log(`[Debug] Found ${window.events.length} events in total.`);

        const eventTypeClassMap = {
            'ç›´æ’­å¼€ç¤º': 'live-dharma-talk',
            'æ³•ä¼š': 'dharma-assembly',
            'æ‰“ä¸ƒ': 'retreat',
            'ç»„ç»‡å¤§ä¼š': 'organization-conference'
        };

        let eventsInMonth = 0;
        window.events.forEach(event => {
            const [eventYear, eventMonthStr, eventDay] = event.date.split('-');
            if (parseInt(eventYear) === year && parseInt(eventMonthStr) === (month + 1)) {
                eventsInMonth++;
                console.log(`[Debug] Found event in this month: "${event.title}" on ${event.date}`);
                
                const dayElement = document.querySelector(`.day-cell[data-date='${event.date}']`);
                const eventClass = eventTypeClassMap[event.type];

                if (dayElement && eventClass) {
                    console.log(`[Debug] Found day cell for ${event.date}. Applying class: event-${eventClass}`);
                    dayElement.classList.add(`event-${eventClass}`);
                    
                    if (!dayElement.dataset.hasEvent) {
                        const tooltipHtml = `<b>${event.title}</b><br>${event.description}`;
                        dayElement.addEventListener('mousemove', (e) => showTooltip(e, tooltipHtml));
                        dayElement.addEventListener('mouseleave', hideTooltip);
                        dayElement.dataset.hasEvent = 'true';
                    }
                } else if (!dayElement) {
                    console.warn(`[Debug] Could not find day cell for date: ${event.date}`);
                } else if (!eventClass) {
                    console.warn(`[Debug] No CSS class mapping for event type: "${event.type}"`);
                }
            }
        });
        if (eventsInMonth === 0) {
            console.log("[Debug] No events found for the currently displayed month.");
        }
  </script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Noto Serif SC", serif; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    /* Custom scrollbar for desktop */
    @media (min-width: 1024px) {
      .custom-scrollbar::-webkit-scrollbar { width: 8px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(139, 69, 19, 0.2); border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(139, 69, 19, 0.4); }
    }
    /* Special Event Styles */
    .event-live-dharma-talk { background-color: gold !important; color: black !important; border-radius: 0.75rem; }
    .event-dharma-assembly { background-color: #FFC107 !important; border: 2px solid gold; border-radius: 0.75rem; }
    .event-retreat { background-color: #FFFACD !important; border: 2px solid gold; border-radius: 0.75rem; }
    .event-organization-conference { background-color: #AEC6CF !important; border-radius: 0.75rem; }

    #event-tooltip {
      position: fixed;
      display: none;
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      pointer-events: none; /* So it doesn't interfere with mouse events */
      max-width: 250px;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(4px);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#f8c390] via-[#f9dba0] to-[#fbf2d3] bg-fixed text-[#4a3b32] pb-24 lg:pb-0 selection:bg-[#b35c1e] selection:text-white min-h-screen">

<div id="event-tooltip"></div>

<div class="lg:flex lg:h-screen lg:overflow-hidden lg:pb-0">
    <!-- Desktop/Pad Sidebar (Navigation) -->
    <header class="lg:w-64 lg:h-full lg:flex-col lg:justify-start lg:border-r lg:border-white/20 lg:bg-white/40 lg:backdrop-blur-xl lg:pt-8 lg:pb-4 flex justify-between items-center px-4 py-3 bg-white/30 backdrop-blur-xl sticky top-0 z-30 shadow-sm border-b border-white/30 transition-all duration-300 lg:static lg:shadow-none">
      
      <!-- Logo Area -->
      <div class="flex justify-between lg:flex-col items-center lg:gap-4 lg:mb-8 w-full lg:px-6">
          <div id="app-title" class="text-lg lg:text-2xl font-bold tracking-wide text-[#5c4033] drop-shadow-sm order-2 lg:order-1 flex items-center gap-2">
            <img src="flag.png" alt="Flag" class="h-7">
            <span>ç‡ƒç‡ˆä½›æ›†</span>
          </div>
          
          <!-- Mobile Settings/Add Buttons (Hidden on Desktop) -->
          <button onclick="toggleSettings()" class="lg:hidden w-9 h-9 flex justify-center items-center text-[#8B4513] text-lg active:scale-90 transition-transform hover:bg-white/40 rounded-full border border-white/20 shadow-sm order-1">
            âš™ï¸
          </button>
          <a href="add_event.html" class="lg:hidden w-9 h-9 flex justify-center items-center text-[#8B4513] text-2xl leading-none no-underline active:scale-90 transition-transform bg-white/40 rounded-full shadow-sm hover:bg-white/60 border border-white/20 order-3">
            +
          </a>
      </div>

      <!-- Desktop Navigation Links (Replaces Bottom Bar) -->
      <nav class="hidden lg:flex flex-col w-full px-4 gap-2 flex-1">
          <button onclick="switchTab('calendar')" id="nav-desktop-calendar" class="flex items-center gap-3 px-4 py-3 rounded-xl text-[#8c7853] hover:bg-white/50 transition-all font-bold text-lg">
              <span>ğŸ“…</span> <span data-i18n="tab_calendar">æ—¥å†</span>
          </button>
          <button onclick="switchTab('search')" id="nav-desktop-search" class="flex items-center gap-3 px-4 py-3 rounded-xl text-[#8c7853] hover:bg-white/50 transition-all font-bold text-lg">
              <span>ğŸ”</span> <span data-i18n="tab_search">æœç´¢</span>
          </button>
          <button onclick="switchTab('dharma')" id="nav-desktop-dharma" class="flex items-center gap-3 px-4 py-3 rounded-xl text-[#8c7853] hover:bg-white/50 transition-all font-bold text-lg">
              <span>ğŸ“š</span> <span data-i18n="tab_dharma">ä½›æ³•</span>
          </button>
          <button onclick="switchTab('diet')" id="nav-desktop-diet" class="flex items-center gap-3 px-4 py-3 rounded-xl text-[#8c7853] hover:bg-white/50 transition-all font-bold text-lg">
              <span>ğŸ¥—</span> <span data-i18n="tab_diet">ç´ æ–‹</span>
          </button>
          <button onclick="switchTab('chant')" id="nav-desktop-chant" class="flex items-center gap-3 px-4 py-3 rounded-xl text-[#8c7853] hover:bg-white/50 transition-all font-bold text-lg">
              <span>ğŸ“¿</span> <span data-i18n="tab_chant">åŠŸè¯¾</span>
          </button>
      </nav>

      <!-- Desktop Footer Actions -->
      <div class="hidden lg:flex flex-col gap-3 px-6 w-full mt-auto">
          <a href="add_event.html" class="flex items-center justify-center w-full py-3 bg-[#b35c1e] text-white rounded-xl shadow-md hover:bg-[#8B4513] transition-colors font-bold">
              <span data-i18n="event_add_title">+ å¤‡å¿˜</span>
          </a>
          <button onclick="toggleSettings()" class="flex items-center justify-center gap-2 w-full py-3 bg-white/40 text-[#5c4033] rounded-xl hover:bg-white/60 transition-colors font-bold border border-white/20">
              <span>âš™ï¸</span> <span data-i18n="settings">è®¾ç½®</span>
          </button>
      </div>
    </header>

    <!-- Content Wrapper for Scrollbar -->
    <div class="flex-1 lg:h-full lg:overflow-y-auto custom-scrollbar">
        <!-- Main Content Area -->
        <main class="px-4 py-1 max-w-md lg:max-w-5xl mx-auto w-full lg:p-8 scroll-smooth">

  <section id="tab-calendar" class="tab-content block pt-2">
    
    <!-- Calendar Card -->
    <div class="bg-gradient-to-br from-white/60 to-[#f8c390]/20 backdrop-blur-2xl rounded-3xl p-4 mb-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 relative overflow-hidden">
      <!-- Decorative Element -->
      <div class="absolute -top-10 -right-10 w-32 h-32 bg-[#f8c390]/20 rounded-full blur-2xl pointer-events-none"></div>
      
      <!-- Header with Month Switcher -->
      <div class="flex justify-between items-center mb-4 px-1 relative z-10">
        <button onclick="changeMonth(-1)" class="p-2.5 hover:bg-white/50 rounded-full text-[#8B4513] transition-all active:scale-90 shadow-sm border border-white/40 bg-white/20">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
        </button>
        <div id="calendar-header" class="text-xl font-serif font-bold text-[#5c4033] tracking-wide drop-shadow-sm"></div>
        <button onclick="changeMonth(1)" class="p-2.5 hover:bg-white/50 rounded-full text-[#8B4513] transition-all active:scale-90 shadow-sm border border-white/40 bg-white/20">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
        </button>
      </div>
      
      <!-- Weekday Headers -->
      <div id="weekday-header" class="grid grid-cols-7 gap-1 mb-3 text-center text-xs text-[#8B4513] font-bold tracking-wider opacity-80">
        <!-- Populated by JS -->
      </div>
      
      <!-- Calendar Grid -->
      <div id="calendar-grid" class="grid grid-cols-7 gap-0.5"></div>
    </div>

    <!-- Day Info Card -->
    <div class="bg-white/40 backdrop-blur-2xl rounded-3xl p-6 mb-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 transition-all duration-300" id="day-info-card">
      <div class="text-[#8B4513] text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-[#8B4513] shadow-sm"></span>
        ä»Šæ—¥è¨Šæ¯
      </div>
      <div id="day-detail" class="text-[#5c4033]">
        <!-- Default content will be set by JS -->
      </div>
    </div>

    <!-- Daily Tip Card -->
    <div class="bg-white/40 backdrop-blur-2xl rounded-3xl p-6 mb-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40">
      <div class="text-[#8B4513] text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
         <span class="w-2 h-2 rounded-full bg-[#8B4513] shadow-sm"></span>
         ä»Šæ—¥ä¿®è¡Œæç¤º
      </div>
      <div id="announcement-container" class="text-[#5c4033] text-sm leading-relaxed font-serif font-medium opacity-90 min-h-[100px]">
        <div class="flex justify-center items-center h-full pt-4">
            <div class="animate-pulse text-stone-400">æ­£åœ¨è·å–æœ€æ–°é€šå‘Š...</div>
        </div>
      </div>
      <script>
        function loadAnnouncement() {
            // Fetch raw HTML content with cache busting
            fetch('announcement.html?t=' + Date.now())
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(html => {
                    const container = document.getElementById('announcement-container');
                    if (!container) return;
                    
                    // Directly inject the HTML content
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error('Failed to load announcement', err);
                    const container = document.getElementById('announcement-container');
                    if (container) {
                         // Fallback UI
                         container.innerHTML = `<div class="text-center text-stone-400 py-4">æ— æ³•åŠ è½½å…¬å‘Šï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>`;
                    }
                });
        }
        
        loadAnnouncement();
        
        // Refresh when visible
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') loadAnnouncement();
        });
      </script>
    </div>

  </section>

  <section id="tab-search" class="tab-content hidden h-full flex flex-col">
    <!-- Search Header -->
    <div class="sticky top-0 z-10 bg-gradient-to-b from-white/40 to-white/20 backdrop-blur-md pb-4 pt-2 border-b border-white/20">
        <div class="relative px-2">
            <input type="text" id="search-input" placeholder="æœç´¢é–‹ç¤ºã€ä½›ç¶“..." data-i18n-placeholder="search_placeholder"
                   class="w-full bg-white/60 backdrop-blur-sm rounded-2xl border border-white/50 px-10 py-3 text-[#5c4033] placeholder-stone-400 focus:outline-none focus:border-[#8B4513]/50 focus:ring-2 focus:ring-[#8B4513]/20 shadow-inner transition-all"
                   oninput="performSearch(this.value)">
            <div class="absolute left-5 top-3.5 text-[#8B4513]/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <button onclick="clearSearch()" id="search-clear" class="absolute right-5 top-3.5 text-[#8B4513]/50 hidden hover:text-[#8B4513] transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        
        <!-- Filters -->
        <div class="flex gap-2 mt-3 overflow-x-auto pb-1 no-scrollbar px-2" id="search-filters">
            <button onclick="filterSearch('all')" class="filter-btn active px-4 py-1.5 rounded-full text-xs font-bold border border-[#8B4513] bg-[#8B4513] text-white shadow-sm whitespace-nowrap transition-all active:scale-95" data-filter="all" data-i18n="filter_all">å…¨éƒ¨</button>
            <button onclick="filterSearch('teaching')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold border border-white/50 bg-white/40 text-[#5c4033] backdrop-blur-sm whitespace-nowrap hover:bg-white/60 hover:border-[#8B4513]/30 transition-all active:scale-95" data-filter="teaching" data-i18n="filter_teaching">æ–‡å­—é–‹ç¤º</button>
            <button onclick="filterSearch('sutra')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold border border-white/50 bg-white/40 text-[#5c4033] backdrop-blur-sm whitespace-nowrap hover:bg-white/60 hover:border-[#8B4513]/30 transition-all active:scale-95" data-filter="sutra" data-i18n="filter_sutra">ä½›ç¶“</button>
            <button onclick="filterSearch('search_result')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold border border-white/50 bg-white/40 text-[#5c4033] backdrop-blur-sm whitespace-nowrap hover:bg-white/60 hover:border-[#8B4513]/30 transition-all active:scale-95" data-filter="search_result" data-i18n="filter_result">æ›´å¤šçµæœ</button>
        </div>
    </div>

    <!-- Results List -->
    <div id="search-results" class="flex-1 overflow-y-auto space-y-3 pb-20 pt-2">
        <!-- Populated by JS -->
    </div>
  </section>

  <section id="tab-dharma" class="tab-content hidden px-1">
    
    <div class="space-y-4 pb-20 pt-2">
        <!-- 1. Sutras (Moved to top) -->
        <div class="group">
            <div onclick="toggleDharmaSection('sutras')" class="relative overflow-hidden bg-white/40 backdrop-blur-xl rounded-2xl p-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 flex items-center gap-4 transition-all active:scale-95 cursor-pointer z-10 hover:bg-white/50">
                <div class="w-12 h-12 rounded-full bg-rose-100/80 backdrop-blur-sm text-rose-600 flex items-center justify-center text-xl shadow-inner ring-4 ring-white/50">
                    ğŸ“œ
                </div>
                <div class="flex-1">
                    <div class="font-bold text-[#5c4033] text-lg" data-i18n="dharma_sutras">ä½›ç¶“é–±è¦½</div>
                    <div class="text-xs text-[#8B4513]/60" data-i18n="dharma_sutras_sub">æ·±å…¥ç¶“è—ï¼Œæ™ºæ…§å¦‚æµ·</div>
                </div>
                <div class="w-8 h-8 rounded-full bg-white/50 flex items-center justify-center text-[#8B4513]/40 group-hover:bg-rose-50 group-hover:text-rose-500 transition-colors">
                    <svg id="icon-sutras" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 transition-transform duration-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </div>
            </div>
            
            <!-- Content -->
            <div id="content-sutras" class="hidden mt-2 mx-2 bg-white/30 backdrop-blur-md rounded-xl border border-white/30 overflow-hidden shadow-inner">
                <div id="sutras-list" class="max-h-[60vh] overflow-y-auto p-2">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- 2. Text Teachings (Accordion) -->
        <div class="group">
            <div onclick="toggleDharmaSection('text-teachings')" class="relative overflow-hidden bg-white/40 backdrop-blur-xl rounded-2xl p-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 flex items-center gap-4 transition-all active:scale-95 cursor-pointer z-10 hover:bg-white/50">
                <!-- Icon -->
                <div class="w-12 h-12 rounded-full bg-amber-100/80 backdrop-blur-sm text-amber-600 flex items-center justify-center text-xl shadow-inner ring-4 ring-white/50">
                    ğŸ“–
                </div>
                <!-- Text -->
                <div class="flex-1">
                    <div class="font-bold text-[#5c4033] text-lg" data-i18n="dharma_text">æ–‡å­—é–‹ç¤º</div>
                    <div class="text-xs text-[#8B4513]/60" data-i18n="dharma_text_sub">ä½›é™€é–‹ç¤ºé›†</div>
                </div>
                <!-- Chevron -->
                <div class="w-8 h-8 rounded-full bg-white/50 flex items-center justify-center text-[#8B4513]/40 group-hover:bg-amber-50 group-hover:text-amber-500 transition-colors">
                    <svg id="icon-text-teachings" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 transition-transform duration-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </div>
            </div>
            
            <!-- Content -->
            <div id="content-text-teachings" class="hidden mt-2 mx-2 bg-white/30 backdrop-blur-md rounded-xl border border-white/30 overflow-hidden shadow-inner">
                <div id="text-teachings-list" class="max-h-[60vh] overflow-y-auto p-2">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- 3. Audio Teachings (Accordion) -->
        <div class="group">
            <div onclick="toggleDharmaSection('audio')" class="relative overflow-hidden bg-white/40 backdrop-blur-xl rounded-2xl p-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 flex items-center gap-4 transition-all active:scale-95 cursor-pointer z-10 hover:bg-white/50">
                <!-- Icon -->
                <div class="w-12 h-12 rounded-full bg-purple-100/80 backdrop-blur-sm text-purple-600 flex items-center justify-center text-xl shadow-inner ring-4 ring-white/50">
                    ğŸ§
                </div>
                <!-- Text -->
                <div class="flex-1">
                    <div class="font-bold text-[#5c4033] text-lg" data-i18n="dharma_audio">éŸ³é¢‘é–‹ç¤º</div>
                    <div class="text-xs text-[#8B4513]/60" data-i18n="dharma_audio_sub">è†å¬æ³•éŸ³</div>
                </div>
                <!-- Chevron -->
                <div class="w-8 h-8 rounded-full bg-white/50 flex items-center justify-center text-[#8B4513]/40 group-hover:bg-purple-50 group-hover:text-purple-500 transition-colors">
                    <svg id="icon-audio" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 transition-transform duration-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </div>
            </div>
            
            <!-- Content -->
            <div id="content-audio" class="hidden mt-2 mx-2 bg-white/30 backdrop-blur-md rounded-xl border border-white/30 overflow-hidden shadow-inner">
                <div id="audio-list" class="max-h-[60vh] overflow-y-auto p-2 space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- 4. Video Teachings -->
        <div class="group">
            <div onclick="toggleDharmaSection('video')" class="relative overflow-hidden bg-white/40 backdrop-blur-xl rounded-2xl p-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 flex items-center gap-4 transition-all active:scale-95 cursor-pointer z-10 hover:bg-white/50">
                <div class="w-12 h-12 rounded-full bg-blue-100/80 backdrop-blur-sm text-blue-600 flex items-center justify-center text-xl shadow-inner ring-4 ring-white/50">
                    ğŸ¥
                </div>
                <div class="flex-1">
                    <div class="font-bold text-[#5c4033] text-lg" data-i18n="dharma_video">å½±ç‰‡é–‹ç¤º</div>
                    <div class="text-xs text-[#8B4513]/60" data-i18n="dharma_video_sub">æ³•æœƒèˆ‡è¬›åº§è¦–é »</div>
                </div>
                 <div class="w-8 h-8 rounded-full bg-white/50 flex items-center justify-center text-[#8B4513]/40 group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors">
                    <svg id="icon-video" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 transition-transform duration-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </div>
            </div>
            
            <!-- Content -->
            <div id="content-video" class="hidden mt-2 mx-2 bg-white/30 backdrop-blur-md rounded-xl border border-white/30 overflow-hidden shadow-inner">
                <div id="video-list" class="max-h-[60vh] overflow-y-auto p-2">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- 5. Masters -->
        <div class="group">
            <div onclick="toggleDharmaSection('masters')" class="relative overflow-hidden bg-white/40 backdrop-blur-xl rounded-2xl p-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 flex items-center gap-4 transition-all active:scale-95 cursor-pointer z-10 hover:bg-white/50">
                <div class="w-12 h-12 rounded-full bg-purple-100/80 backdrop-blur-sm text-purple-600 flex items-center justify-center text-xl shadow-inner ring-4 ring-white/50">
                    ğŸ‘¤
                </div>
                <div class="flex-1">
                    <div class="font-bold text-[#5c4033] text-lg" data-i18n="dharma_master">ç¥–å¸«å¤§å¾·</div>
                    <div class="text-xs text-[#8B4513]/60" data-i18n="dharma_master_sub">æ­·ä»£é«˜åƒ§è¡Œèª¼</div>
                </div>
                <div class="w-8 h-8 rounded-full bg-white/50 flex items-center justify-center text-[#8B4513]/40 group-hover:bg-purple-50 group-hover:text-purple-500 transition-colors">
                    <svg id="icon-masters" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 transition-transform duration-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </div>
            </div>
            
            <!-- Content -->
            <div id="content-masters" class="hidden mt-2 mx-2 bg-white/30 backdrop-blur-md rounded-xl border border-white/30 overflow-hidden shadow-inner">
                <div id="masters-list" class="max-h-[60vh] overflow-y-auto p-2">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- 5. Sutras (Moved to top) -->
        <!-- Removed from here -->

    </div>
  </section>

  <section id="tab-chant" class="tab-content hidden h-full flex flex-col">
    <!-- Mode Switcher -->
    <div class="px-4 pt-2 pb-4">
        <div class="flex p-1 bg-orange-100/30 backdrop-blur-sm border border-white/40 rounded-xl mx-1 shadow-inner">
            <button onclick="switchChantMode('counter')" id="btn-mode-counter" class="flex-1 py-2 rounded-lg text-sm font-bold shadow-sm bg-white text-[#b35c1e] transition-all duration-200" data-i18n="chant_counter">å¿µä½›è¨ˆæ•¸</button>
            <button onclick="switchChantMode('meditation')" id="btn-mode-meditation" class="flex-1 py-2 rounded-lg text-sm font-bold text-[#8B4513]/60 hover:text-[#b35c1e] hover:bg-white/40 transition-all duration-200" data-i18n="chant_timer">æ‰“åè¨ˆæ™‚</button>
            <button onclick="switchChantMode('stats')" id="btn-mode-stats" class="flex-1 py-2 rounded-lg text-sm font-bold text-[#8B4513]/60 hover:text-[#b35c1e] hover:bg-white/40 transition-all duration-200" data-i18n="stats_title">çµ±è¨ˆ</button>
        </div>
    </div>

    <!-- Mode: Counter -->
    <div id="mode-counter" class="flex-1 overflow-y-auto px-1 pb-20 animate-in fade-in slide-in-from-bottom-2 duration-300">
        <div class="bg-white/40 backdrop-blur-xl rounded-3xl p-5 mb-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40">
            <div class="text-[#8B4513] text-xs font-bold uppercase tracking-wider mb-4 flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-[#8B4513]"></span>
                <span data-i18n="today_homework">ä»Šæ—¥åŠŸèª²</span>
            </div>
            
            <!-- Counter Card -->
            <div class="bg-white/30 rounded-2xl p-6 text-center border border-white/40 shadow-inner relative overflow-hidden backdrop-blur-sm">
                <div class="absolute top-0 left-0 w-full h-1 bg-[#8B4513]/20"></div>
                <div class="text-[#8B4513]/70 text-sm mb-2 font-serif font-bold" data-i18n="chant_target">å—ç„¡é˜¿å½Œé™€ä½›</div>
                <div id="counter-display" class="text-6xl font-bold text-[#5c4033] font-serif my-6 tracking-widest tabular-nums drop-shadow-sm">0</div>
                <div class="flex justify-center gap-6 mt-8 items-center">
                    <button onclick="updateCounter(-1)" class="w-12 h-12 flex items-center justify-center rounded-full bg-white/40 text-[#8B4513]/60 active:scale-95 transition-all hover:bg-white/60 border border-white/50 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
                        </svg>
                    </button>
                    <button onclick="updateCounter(1)" class="w-24 h-24 flex items-center justify-center rounded-full bg-gradient-to-br from-[#f8c390] to-[#eeb075] text-[#5c4033] shadow-[0_10px_20px_rgba(248,195,144,0.4)] active:scale-90 transition-all hover:shadow-[0_15px_30px_rgba(248,195,144,0.5)] border-4 border-white/30 ring-4 ring-[#f8c390]/20">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-10 h-10">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                    </button>
                     <button onclick="saveCounterRecord()" class="w-12 h-12 flex items-center justify-center rounded-full bg-emerald-100/50 text-emerald-600 active:scale-95 transition-all hover:bg-emerald-100/80 border border-emerald-100 shadow-sm" title="ä¿å­˜è¨˜éŒ„">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
                <div class="mt-6 text-xs text-[#8B4513]/50 font-medium" data-i18n="chant_count_today">é»æ“Šç¶ è‰²æŒ‰éˆ•ä¿å­˜ä¸¦æ­¸é›¶</div>
            </div>
        </div>
        
        <div class="bg-white/40 backdrop-blur-xl rounded-3xl p-5 mb-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40">
            <div class="flex items-center justify-between mb-2">
                 <div class="text-[#8B4513] text-xs font-bold uppercase tracking-wider" data-i18n="history_label">æ­·å²è¨˜éŒ„</div>
                 <div class="text-[10px] text-[#8B4513]/50 font-medium">æœ€è¿‘7å¤©</div>
            </div>
            <div id="counter-history" class="space-y-2">
                <!-- JS will populate -->
            </div>
        </div>
    </div>

    <!-- Mode: Meditation -->
    <div id="mode-meditation" class="hidden flex-1 overflow-y-auto px-1 pb-20 animate-in fade-in slide-in-from-bottom-2 duration-300">
         <div class="bg-white/40 backdrop-blur-xl rounded-3xl p-6 mb-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40 flex flex-col items-center">
            <div class="text-[#8B4513] text-xs font-bold uppercase tracking-wider mb-8 flex items-center gap-2 self-start">
                <span class="w-1.5 h-1.5 rounded-full bg-[#8B4513]"></span>
                <span data-i18n="meditation_mode">ç¦ªåè¨ˆæ™‚</span>
            </div>
            
            <!-- Timer Circle -->
            <div class="relative w-64 h-64 flex items-center justify-center mb-10">
                <!-- Decorative Ring -->
                <div class="absolute inset-0 rounded-full border-[6px] border-white/30 shadow-inner"></div>
                <!-- Progress Ring (SVG) -->
                <svg class="absolute inset-0 w-full h-full -rotate-90 transform drop-shadow-md" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="46" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="6" />
                    <circle id="timer-progress" cx="50" cy="50" r="46" fill="none" stroke="#f8c390" stroke-width="6" stroke-dasharray="289" stroke-dashoffset="0" stroke-linecap="round" class="transition-all duration-1000 ease-linear" />
                </svg>
                
                <!-- Time Display -->
                <div class="flex flex-col items-center z-10">
                    <div id="timer-display" class="text-6xl font-light text-[#5c4033] font-mono tabular-nums tracking-tight drop-shadow-sm">15:00</div>
                    <div id="timer-status" class="text-xs text-[#8B4513]/60 mt-3 font-bold tracking-[0.2em] uppercase" data-i18n="meditation_status_ready">æº–å‚™é–‹å§‹</div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex items-center justify-center gap-8 mb-6">
                <button onclick="resetMeditation()" class="w-14 h-14 flex items-center justify-center rounded-full bg-white/40 text-[#8B4513]/40 hover:bg-white/60 hover:text-[#8B4513]/60 transition-all border border-white/50 shadow-sm" title="é‡ç½®">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <button onclick="toggleMeditation()" id="btn-timer-toggle" class="w-24 h-24 flex items-center justify-center rounded-full bg-gradient-to-br from-[#f8c390] to-[#eeb075] text-[#5c4033] shadow-[0_10px_30px_rgba(248,195,144,0.4)] hover:shadow-[0_15px_40px_rgba(248,195,144,0.5)] transition-all active:scale-95 border-4 border-white/30 ring-4 ring-[#f8c390]/20">
                    <!-- Play Icon -->
                    <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    <!-- Pause Icon (Hidden) -->
                    <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 hidden" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <!-- Save Button -->
                 <button onclick="manualSaveMeditation()" class="w-14 h-14 flex items-center justify-center rounded-full bg-emerald-100/50 text-emerald-600 hover:bg-emerald-100/80 transition-all border border-emerald-100 shadow-sm" title="ä¿å­˜è¨˜éŒ„">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            
            <!-- Alert Settings & Sound -->
            <div class="flex items-center justify-center gap-4 w-full mb-2 bg-white/30 p-3 rounded-2xl border border-white/30 backdrop-blur-sm">
                <div class="flex items-center gap-2">
                    <label class="text-xs text-[#8B4513]/70 font-bold">éŸ¿éˆ´æ™‚é–“</label>
                    <input type="time" id="meditation-alert-input" onchange="meditationAlertPlayed=false" class="w-24 text-center py-1.5 rounded-lg border border-white/50 bg-white/60 text-[#8B4513] text-sm font-bold focus:outline-none focus:border-[#f8c390] shadow-inner">
                </div>
                
                <!-- Sound Toggle -->
                <button onclick="toggleSound()" id="btn-sound" class="w-9 h-9 flex items-center justify-center rounded-full bg-white/60 text-[#8B4513]/60 hover:bg-white/80 transition-colors relative border border-white/50 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <!-- Strike through for mute -->
                    <div id="sound-off-line" class="absolute w-full h-0.5 bg-[#8B4513]/60 rotate-45 hidden"></div>
                </button>
            </div>
         </div>
         
         <!-- Meditation History -->
        <div class="bg-white/40 backdrop-blur-xl rounded-3xl p-5 mb-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40">
            <div class="flex items-center justify-between mb-2">
                 <div class="text-[#8B4513] text-xs font-bold uppercase tracking-wider" data-i18n="history_label">æ‰“åè¨˜éŒ„</div>
                 <div class="text-[10px] text-[#8B4513]/50 font-medium">æœ€è¿‘7å¤©</div>
            </div>
            <div id="meditation-history" class="space-y-2">
                 <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Mode: Stats -->
    <div id="mode-stats" class="hidden flex-1 overflow-y-auto px-1 pb-20 animate-in fade-in slide-in-from-bottom-2 duration-300">
        <div class="bg-white/40 backdrop-blur-xl rounded-3xl p-5 mb-4 shadow-[0_8px_32px_0_rgba(255,255,255,0.3)] border border-white/60 ring-1 ring-white/40">
             <div class="text-[#8B4513] text-xs font-bold uppercase tracking-wider mb-4 flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-[#8B4513]"></span>
                <span data-i18n="stats_title">æœˆåº¦ç»Ÿè®¡</span>
            </div>
            
            <!-- Chant Chart -->
            <div class="mb-6">
                <div class="text-xs text-[#8B4513]/60 mb-2 font-bold" data-i18n="stats_chant">å¿µä½›è®¡æ•°</div>
                <div class="bg-white/30 rounded-xl p-4 border border-white/40 shadow-inner h-48 flex items-end justify-between gap-1" id="chart-chant">
                    <!-- Bars injected by JS -->
                </div>
            </div>

            <!-- Meditation Chart -->
            <div>
                <div class="text-xs text-[#8B4513]/60 mb-2 font-bold" data-i18n="stats_meditation">ç¦…åæ—¶é•¿ (åˆ†é’Ÿ)</div>
                <div class="bg-white/30 rounded-xl p-4 border border-white/40 shadow-inner h-48 flex items-end justify-between gap-1" id="chart-meditation">
                    <!-- Bars injected by JS -->
                </div>
            </div>
        </div>
    </div>

  </section>

    <!-- Mode: Zen Diet (Vegetarian) -->
    <div id="tab-diet" class="tab-content hidden flex-1 overflow-y-auto px-1 pb-20 animate-in fade-in slide-in-from-bottom-2 duration-300">
        
        <!-- Loading Overlay (Global for Diet Tab) -->
        <div id="diet-loading" class="hidden absolute inset-0 z-20 bg-white/40 backdrop-blur-md flex flex-col items-center justify-center pt-20">
             <div class="bg-white/80 p-4 rounded-full shadow-lg mb-3 animate-bounce border border-white/60">
                <svg class="h-6 w-6 text-green-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
             </div>
             <span class="text-xs font-bold text-green-800 bg-white/80 px-4 py-1.5 rounded-full shadow-sm border border-green-100 backdrop-blur-sm" data-i18n="diet_loading">æ­£åœ¨å°‹å‘³...</span>
        </div>

        <!-- Recipes Container -->
        <div id="diet-container" class="space-y-4 pt-1">
            <!-- Content will be injected here -->
        </div>

    </div>
</main>
</div>
</div>

<!-- AdMob Banner Placeholder -->
<div id="ad-banner-container" class="lg:hidden fixed bottom-[56px] left-0 right-0 z-30 flex justify-center items-center bg-white/30 backdrop-blur-sm border-t border-white/20" style="height: 50px;">
    <div class="w-[320px] h-[50px] bg-black/5 rounded flex items-center justify-center text-xs text-[#8B4513]/40 border border-white/10">
        AdMob Banner (320x50)
    </div>
</div>

<!-- Bottom Navigation (Floating Glass) -->
<nav class="lg:hidden fixed bottom-6 left-6 right-6 flex bg-white/60 backdrop-blur-2xl border border-white/50 rounded-full z-40 shadow-[0_8px_32px_rgba(0,0,0,0.1)] h-[64px] items-center justify-around px-2 ring-1 ring-white/40 transition-all duration-300">
  <button id="btn-tab-calendar" class="flex-1 flex flex-col items-center justify-center gap-0.5 text-[#8B4513] font-bold transition-all active:scale-90" onclick="switchTab('calendar', this)">
    <span class="text-2xl drop-shadow-sm">ğŸ—“ï¸</span>
    <span class="text-[10px]" data-i18n="tab_calendar">æ—¥æ›†</span>
  </button>
  <button id="btn-tab-search" class="flex-1 flex flex-col items-center justify-center gap-0.5 text-[#8B4513]/60 hover:text-[#8B4513] transition-all active:scale-90" onclick="switchTab('search', this)">
    <span class="text-2xl drop-shadow-sm opacity-80">ğŸ”</span>
    <span class="text-[10px]" data-i18n="tab_search">æœç´¢</span>
  </button>
  <button id="btn-tab-dharma" class="flex-1 flex flex-col items-center justify-center gap-0.5 text-[#8B4513]/60 hover:text-[#8B4513] transition-all active:scale-90" onclick="switchTab('dharma', this)">
    <span class="text-2xl drop-shadow-sm opacity-80">â˜¸ï¸</span>
    <span class="text-[10px]" data-i18n="tab_dharma">ä½›æ³•</span>
  </button>
  <button id="btn-tab-diet" class="flex-1 flex flex-col items-center justify-center gap-0.5 text-[#8B4513]/60 hover:text-[#8B4513] transition-all active:scale-90" onclick="switchTab('diet', this)">
    <span class="text-2xl drop-shadow-sm opacity-80">ğŸ¥—</span>
    <span class="text-[10px]" data-i18n="tab_diet">ç´ æ–‹</span>
  </button>
  <button id="btn-tab-chant" class="flex-1 flex flex-col items-center justify-center gap-0.5 text-[#8B4513]/60 hover:text-[#8B4513] transition-all active:scale-90" onclick="switchTab('chant', this)">
    <span class="text-2xl drop-shadow-sm opacity-80">ğŸ“¿</span>
    <span class="text-[10px]" data-i18n="tab_chant">åŠŸèª²</span>
  </button>
</nav>

<!-- Settings Modal (Glassmorphism) -->
<div id="settings-modal" class="fixed inset-0 z-50 hidden" style="display: none;">
    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity" onclick="toggleSettings()"></div>
    <div class="absolute top-20 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-2xl p-6 rounded-3xl shadow-[0_20px_50px_-12px_rgba(0,0,0,0.25)] w-80 border border-white/60 animate-in fade-in slide-in-from-bottom-8 duration-300 ring-1 ring-white/50">
        <div class="flex justify-between items-center mb-6 border-b border-[#8B4513]/10 pb-3">
            <span class="font-bold text-[#5c4033] flex items-center gap-2 text-lg" data-i18n="settings">
                âš™ï¸ è¨­ç½®
            </span>
            <button onclick="toggleSettings()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-[#8B4513]/10 text-[#8B4513]/60 transition-colors">âœ•</button>
        </div>
        
        <div class="space-y-6">
             <!-- Language Selector -->
             <div>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs text-[#8B4513]/80 font-bold uppercase tracking-wider" data-i18n="language_label">è¯­è¨€ / Language</span>
                </div>
                <div class="flex gap-2">
                    <button id="btn-lang-cn" onclick="setLanguage('zh-CN')" class="flex-1 py-2 rounded-xl border border-white/50 bg-white/40 text-sm text-[#5c4033] font-medium hover:bg-[#f8c390]/30 hover:border-[#f8c390] hover:text-[#8B4513] transition-all active:scale-95 shadow-sm">ç®€ä½“</button>
                    <button id="btn-lang-tw" onclick="setLanguage('zh-TW')" class="flex-1 py-2 rounded-xl border border-white/50 bg-white/40 text-sm text-[#5c4033] font-medium hover:bg-[#f8c390]/30 hover:border-[#f8c390] hover:text-[#8B4513] transition-all active:scale-95 shadow-sm">ç¹é«”</button>
                    <button id="btn-lang-en" onclick="setLanguage('en')" class="flex-1 py-2 rounded-xl border border-white/50 bg-white/40 text-sm text-[#5c4033] font-medium hover:bg-[#f8c390]/30 hover:border-[#f8c390] hover:text-[#8B4513] transition-all active:scale-95 shadow-sm">En</button>
                </div>
            </div>

            <hr class="border-[#8B4513]/10">

             <!-- Buddhist Era Selector -->
             <div>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs text-[#8B4513]/80 font-bold uppercase tracking-wider" data-i18n="era_label">ä½›å†è®¡ç®— / Era</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="setEraOffset(543)" id="btn-era-543" class="flex-1 py-2 rounded-xl border border-white/50 bg-white/40 text-xs font-medium text-[#5c4033] hover:bg-[#f8c390]/30 hover:border-[#f8c390] hover:text-[#8B4513] transition-all active:scale-95 shadow-sm">+543 (æ³°)</button>
                    <button onclick="setEraOffset(544)" id="btn-era-544" class="flex-1 py-2 rounded-xl border border-white/50 bg-white/40 text-xs font-medium text-[#5c4033] hover:bg-[#f8c390]/30 hover:border-[#f8c390] hover:text-[#8B4513] transition-all active:scale-95 shadow-sm">+544 (ä¸­)</button>
                </div>
            </div>

            <hr class="border-[#8B4513]/10">

            <div>
                <div class="flex justify-between text-xs text-[#8B4513]/80 font-bold uppercase tracking-wider mb-3">
                    <span>å­—é«”å¤§å°</span>
                    <span id="font-size-label" class="text-[#8B4513]">18px</span>
                </div>
                <input type="range" id="font-size-slider" min="14" max="32" step="1" value="18" 
                       class="w-full h-2 bg-[#8B4513]/20 rounded-lg appearance-none cursor-pointer accent-[#8B4513]"
                       oninput="updateFontSize(this.value)">
                <div class="flex justify-between text-[10px] text-[#8B4513]/50 mt-1 font-medium">
                    <span>A</span>
                    <span>A</span>
                </div>
            </div>
            
            <div class="p-3 bg-white/40 rounded-xl border border-white/50 text-[#5c4033] text-justify leading-relaxed transition-all duration-200 text-xs shadow-inner" id="settings-preview-text">
                é è¦½æ–‡å­— Preview Text.<br>æ­¤è¨­ç½®åƒ…å½±éŸ¿ä½›ç¶“èˆ‡é–‹ç¤ºçš„é–±è®€é é¢ã€‚
            </div>
        </div>
    </div>
</div>

<script>
  // Settings Logic
  function toggleSettings() {
      const modal = document.getElementById('settings-modal');
      if (modal.style.display === 'none' || modal.style.display === '') {
          modal.style.display = 'block';
          // Initialize slider value
          const currentSize = localStorage.getItem('reader_font_size') || 18;
          document.getElementById('font-size-slider').value = currentSize;
          updateFontSize(currentSize, false);
          
          // Initialize Era Buttons
          updateEraButtons();
          // Initialize Language Buttons
          updateLanguageButtons();
      } else {
          modal.style.display = 'none';
      }
  }

  function setEraOffset(offset) {
      localStorage.setItem('buddhist_era_offset', offset);
      updateEraButtons();
      // Re-render calendar to reflect change
      renderCalendar();
      // Re-render header year if needed
      updateAppHeader();
  }

  function updateEraButtons() {
      const offset = parseInt(localStorage.getItem('buddhist_era_offset') || 544);
      const btn543 = document.getElementById('btn-era-543');
      const btn544 = document.getElementById('btn-era-544');
      
      const baseClass = "flex-1 py-2 rounded-xl border border-white/50 bg-white/40 text-xs font-medium text-[#5c4033] hover:bg-[#f8c390]/30 hover:border-[#f8c390] hover:text-[#8B4513] transition-all active:scale-95 shadow-sm";
      const activeClass = "flex-1 py-2 rounded-xl border border-[#f8c390] bg-[#f8c390] text-xs font-bold text-[#5c4033] transition-all active:scale-95 shadow-md ring-1 ring-[#f8c390]/50";

      if(offset === 543) {
          btn543.className = activeClass;
          btn544.className = baseClass;
      } else {
          btn544.className = activeClass;
          btn543.className = baseClass;
      }
  }

  function updateLanguageButtons() {
      const lang = localStorage.getItem('app_language') || 'zh-TW';
      const btnCN = document.getElementById('btn-lang-cn');
      const btnTW = document.getElementById('btn-lang-tw');
      const btnEN = document.getElementById('btn-lang-en');
      
      const baseClass = "flex-1 py-2 rounded-xl border border-white/50 bg-white/40 text-sm text-[#5c4033] font-medium hover:bg-[#f8c390]/30 hover:border-[#f8c390] hover:text-[#8B4513] transition-all active:scale-95 shadow-sm";
      const activeClass = "flex-1 py-2 rounded-xl border border-[#f8c390] bg-[#f8c390] text-sm text-[#5c4033] font-bold transition-all active:scale-95 shadow-md ring-1 ring-[#f8c390]/50";

      // Reset all
      if(btnCN) btnCN.className = baseClass;
      if(btnTW) btnTW.className = baseClass;
      if(btnEN) btnEN.className = baseClass;

      // Set Active
      if(lang === 'zh-CN' && btnCN) btnCN.className = activeClass;
      if(lang === 'zh-TW' && btnTW) btnTW.className = activeClass;
      if(lang === 'en' && btnEN) btnEN.className = activeClass;
  }

  function updateAppHeader() {
      const offset = parseInt(localStorage.getItem('buddhist_era_offset') || 544);
      const year = currentYear + offset;
      const appTitle = document.getElementById('app-title');
      if (appTitle) {
          // Check if current language is English to determine format
          const lang = localStorage.getItem('app_language') || 'zh-TW';
          if (lang === 'en') {
            appTitle.innerHTML = `${t('app_title')} ${year}`;
          } else {
            appTitle.innerHTML = `${t('app_title')} ${year}`;
          }
      }
  }

  function updateFontSize(val, save=true) {
      // Update label
      document.getElementById('font-size-label').innerText = val + 'px';
      // Update preview
      const preview = document.getElementById('settings-preview-text');
      preview.style.fontSize = val + 'px';
      
      // Save
      if(save) {
          localStorage.setItem('reader_font_size', val);
      }
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
      // Apply Language
      const lang = localStorage.getItem('app_language') || 'zh-TW';
      // Initial render for static text is handled by updateDOMWithLanguage inside setLanguage if we called it, 
      // but to avoid reload loop, we just do a pass here.
      // Actually, simplest is to just call a render function.
      
      document.querySelectorAll('[data-i18n]').forEach(el => {
         const key = el.getAttribute('data-i18n');
         el.innerText = t(key);
      });
      
      // Update placeholders
      const searchInput = document.getElementById('search-input');
      if(searchInput) searchInput.placeholder = t('search_placeholder');

      const savedSize = localStorage.getItem('reader_font_size');
      if(savedSize) {
          // Just ensure it's saved, visual update happens when modal opens
      }
      
      // Initialize Search Tab with Suggestions
      if(document.getElementById('search-results')) {
          document.getElementById('search-results').innerHTML = renderSuggestions();
      }
  });

  // ç»´æŠ¤çš„ä½›æ—¥ / æ–‹æ—¥è¡¨
  // èŠ‚æ—¥æ•°æ®æ¥æº: Mingyue Temple ä½›èª•è¡¨
  const buddhistFestivals = {
    '01-01': 'å½Œå‹’è©è–©è–èª•',
    '01-09': 'å¸é‡‹å¤©å°Šè–èª•',
    '01-17': 'ç™¾ä¸ˆæ‡·æµ·ç¦ªå¸«ç´€å¿µæ—¥',
    '02-08': 'é‡‹è¿¦ç‰Ÿå°¼ä½›å‡ºå®¶æ—¥',
    '02-09': 'æ…§èƒ½å¤§å¸«è–èª•',
    '02-15': 'é‡‹è¿¦ç‰Ÿå°¼ä½›æ¶…æ§ƒ',
    '02-19': 'è§€ä¸–éŸ³è©è–©è–èª•',
    '02-21': 'æ™®è³¢è©è–©è–èª•',
    '03-16': 'æº–æç‹è©è–©èª•',
    '04-04': 'æ–‡æ®Šè©è–©è–èª•',
    '04-08': 'é‡‹è¿¦ç‰Ÿå°¼ä½›å¯¶èª•',
    '05-13': 'ä¼½è—è©è–©è–èª•',
    '06-03': 'éŸ‹é¦±è©è–©è–èª•',
    '06-19': 'è§€ä¸–éŸ³è©è–©æˆé“æ—¥',
    '07-13': 'å¤§å‹¢è‡³è©è–©è–èª•',
    '07-15': 'ç›‚è˜­ç›†ç¯€',
    '07-16': 'è«¦æ·±ä½›å†é“æ—¥',
    '07-29': 'è™›é›²è€å’Œå°šèª•è¾°',
    '07-30': 'åœ°è—ç‹è©è–©è–èª•',
    '08-20': 'é³©æ‘©ç¾…ä»€ä¸‰è—ç´€å¿µæ—¥',
    '08-22': 'ç‡ƒç‡ˆå¤ä½›è–èª•',
    '09-19': 'è§€ä¸–éŸ³è©è–©å‡ºå®¶æ—¥',
    '09-30': 'è—¥å¸«ä½›è–èª•',
    '10-03': 'é“å®£å¾‹å¸«ç´€å¿µæ—¥',
    '10-05': 'é”æ‘©ç¥–å¸«è–èª•',
    '10-11': 'æ†¨å±±å¾·æ¸…å¤§å¸«ç´€å¿µæ—¥',
    '11-17': 'é˜¿å½Œé™€ä½›è–èª•',
    '11-18': 'è«¦æ·±ä½›è–èª•',
    '12-08': 'é‡‹è¿¦ç‰Ÿå°¼ä½›æˆé“æ—¥',
    '12-17': 'ç´«æŸçœŸå¯å°Šè€…ç´€å¿µæ—¥'
  };

  // Global Festivals Dictionary (CN, TW, JP, SEA, NA, EU)
  const SOLAR_FESTIVALS = {
      // Global / Western
      '01-01': ['å…ƒæ—¦ (å…¨çƒ)', 'ä¸­è¯æ°‘åœ‹é–‹åœ‹ç´€å¿µæ—¥ (å°ç£)'],
      '02-14': ['æƒ…äººç¯€ (æ­ç¾)'],
      '03-08': ['å©¦å¥³ç¯€ (åœ‹éš›)'],
      '04-01': ['æ„šäººç¯€ (æ­ç¾)'],
      '05-01': ['å‹å‹•ç¯€ (åœ‹éš›)'],
      '10-31': ['è¬è–ç¯€ (åŒ—ç¾/æ­æ´²)'],
      '12-24': ['å¹³å®‰å¤œ (å…¨çƒ)'],
      '12-25': ['è–èª•ç¯€ (å…¨çƒ)'],
      '12-26': ['ç¯€ç¦®æ—¥ (æ­æ´²/è‹±è¯é‚¦)'],
      '12-31': ['è·¨å¹´ (å…¨çƒ)'],

      // China (CN)
      '03-12': ['æ¤æ¨¹ç¯€ (ä¸­åœ‹/å°ç£)'],
      '05-04': ['é’å¹´ç¯€ (ä¸­åœ‹)'],
      '06-01': ['å…’ç«¥ç¯€ (ä¸­åœ‹)'],
      '07-01': ['å»ºé»¨ç¯€ (ä¸­åœ‹)', 'é¦™æ¸¯ç‰¹å€æˆç«‹ç´€å¿µæ—¥'],
      '08-01': ['å»ºè»ç¯€ (ä¸­åœ‹)'],
      '09-10': ['æ•™å¸«ç¯€ (ä¸­åœ‹)'],
      '10-01': ['åœ‹æ…¶ç¯€ (ä¸­åœ‹)'],
      '12-13': ['åœ‹å®¶å…¬ç¥­æ—¥ (ä¸­åœ‹)'],
      '12-20': ['æ¾³é–€ç‰¹å€æˆç«‹ç´€å¿µæ—¥'],

      // Taiwan (TW)
      '02-28': ['å’Œå¹³ç´€å¿µæ—¥ (å°ç£)'],
      '03-29': ['é’å¹´ç¯€ (å°ç£)'],
      '04-04': ['å…’ç«¥ç¯€ (å°ç£/é¦™æ¸¯)'],
      '08-08': ['çˆ¶è¦ªç¯€ (å°ç£)'],
      '09-03': ['è»äººç¯€ (å°ç£)'],
      '09-28': ['æ•™å¸«ç¯€ (å°ç£)'],
      '10-10': ['åœ‹æ…¶æ—¥ (å°ç£)'],
      '10-25': ['å…‰å¾©ç¯€ (å°ç£)'],
      '11-12': ['åœ‹çˆ¶èª•è¾° (å°ç£)'],

      // Europe (Expanded)
      '01-06': ['ä¸»é¡¯ç¯€ (æ­æ´²å¤šåœ‹)'],
      '04-25': ['è§£æ”¾æ—¥ (ç¾©å¤§åˆ©)', 'è‡ªç”±æ—¥ (è‘¡è„ç‰™)'],
      '04-27': ['åœ‹ç‹æ—¥ (è·è˜­)'],
      '04-30': ['æ²ƒæ™®çˆ¾å‰æ–¯ä¹‹å¤œ (ç‘å…¸/èŠ¬è˜­/å¾·åœ‹)'],
      '05-08': ['äºŒæˆ°å‹åˆ©æ—¥ (æ³•åœ‹/æ·å…‹/æ–¯æ´›ä¼å…‹)'],
      '05-17': ['æ†²æ³•æ—¥ (æŒªå¨)'],
      '06-02': ['å…±å’Œåœ‹æ—¥ (ç¾©å¤§åˆ©)'],
      '06-05': ['æ†²æ³•æ—¥ (ä¸¹éº¥)'],
      '06-06': ['åœ‹æ…¶æ—¥ (ç‘å…¸)'],
      '06-23': ['åœ‹æ…¶æ—¥ (ç›§æ£®å ¡)'],
      '07-14': ['å·´å£«åº•æ—¥ (æ³•åœ‹)'],
      '07-21': ['åœ‹æ…¶æ—¥ (æ¯”åˆ©æ™‚)'],
      '08-01': ['åœ‹æ…¶æ—¥ (ç‘å£«)'],
      '08-15': ['è–æ¯å‡å¤©ç¯€ (æ­æ´²å¤šåœ‹)'],
      '10-03': ['çµ±ä¸€æ—¥ (å¾·åœ‹)'],
      '10-12': ['åœ‹æ…¶æ—¥ (è¥¿ç­ç‰™)'],
      '10-26': ['åœ‹æ…¶æ—¥ (å¥§åœ°åˆ©)'],
      '10-28': ['åœ‹æ…¶æ—¥ (æ·å…‹)', 'Oxi Day (å¸Œè‡˜)'],
      '11-01': ['è«¸è–ç¯€ (æ­æ´²å¤šåœ‹)'],
      '11-11': ['åœæˆ°ç´€å¿µæ—¥ (æ³•åœ‹/æ¯”åˆ©æ™‚)', 'ç¨ç«‹æ—¥ (æ³¢è˜­)'],
      '12-06': ['ç¨ç«‹æ—¥ (èŠ¬è˜­)', 'æ†²æ³•æ—¥ (è¥¿ç­ç‰™)'],
      '12-08': ['è–æ¯ç„¡åŸç½ªæ—¥ (ç¾©å¤§åˆ©/è¥¿ç­ç‰™/å¥§åœ°åˆ©)'],
      '12-13': ['è–ç›§è¥¿äºç¯€ (ç‘å…¸/æŒªå¨)'],

      // Japan (JP)
      '01-11': ['æˆäººä¹‹æ—¥ (æ—¥æœ¬)'], // Note: Often 2nd Mon, strictly this is legacy fixed
      '02-11': ['å»ºåœ‹ç´€å¿µä¹‹æ—¥ (æ—¥æœ¬)'],
      '02-23': ['å¤©çš‡èª•ç”Ÿæ—¥ (æ—¥æœ¬)'],
      '04-29': ['æ˜­å’Œä¹‹æ—¥ (æ—¥æœ¬)'],
      '05-03': ['æ†²æ³•ç´€å¿µæ—¥ (æ—¥æœ¬)'],
      '05-04': ['ç¶ ä¹‹æ—¥ (æ—¥æœ¬)'],
      '05-05': ['å…’ç«¥ä¹‹æ—¥ (æ—¥æœ¬)'],
      '11-03': ['æ–‡åŒ–ä¹‹æ—¥ (æ—¥æœ¬)'],
      '11-23': ['å‹¤å‹æ„Ÿè¬ä¹‹æ—¥ (æ—¥æœ¬)'],

      // North America (NA)
      '07-01': ['åŠ æ‹¿å¤§åœ‹æ…¶ (åŒ—ç¾)'],
      '07-04': ['ç¨ç«‹ç´€å¿µæ—¥ (ç¾åœ‹)'],
      '11-11': ['é€€ä¼è»äººç¯€ (åŒ—ç¾)'],

      // Europe (EU) - Major fixed & National
      '01-06': ['ä¸»é¡¯ç¯€ (æ­æ´²/ç‘å…¸/è¥¿ç­ç‰™)'],
      '04-25': ['è§£æ”¾æ—¥ (æ„å¤§åˆ©/è‘¡è„ç‰™)'],
      '05-08': ['äºŒæˆ°å‹åˆ©æ—¥ (æ³•åœ‹/æ·å…‹/æ–¯æ´›ä¼å…‹)'],
      '05-17': ['æ†²æ³•æ—¥ (æŒªå¨)'],
      '06-02': ['å…±å’Œåœ‹æ—¥ (æ„å¤§åˆ©)'],
      '06-05': ['æ†²æ³•æ—¥ (ä¸¹éº¥)'],
      '06-06': ['åœ‹æ…¶æ—¥ (ç‘å…¸)'],
      '06-23': ['åœ‹æ…¶æ—¥ (ç›§æ£®å ¡)'],
      '07-14': ['å·´å£«åº•æ—¥ (æ³•åœ‹)'],
      '07-21': ['åœ‹æ…¶æ—¥ (æ¯”åˆ©æ™‚)'],
      '08-01': ['åœ‹æ…¶æ—¥ (ç‘å£«)'],
      '08-15': ['è–æ¯å‡å¤©ç¯€ (æ­æ´²)'],
      '09-27': ['æ³•èªç¤¾å€ç¯€ (æ¯”åˆ©æ™‚)'],
      '10-03': ['çµ±ä¸€æ—¥ (å¾·åœ‹)'],
      '10-12': ['åœ‹æ…¶æ—¥ (è¥¿ç­ç‰™)'],
      '10-26': ['åœ‹æ…¶æ—¥ (å¥§åœ°åˆ©)'],
      '10-28': ['åƒæˆ°ç´€å¿µæ—¥ (å¸Œè‡˜/æ·å…‹)'],
      '11-01': ['è«¸è–ç¯€ (æ­æ´²)'],
      '11-11': ['åœæˆ°æ—¥ (æ³•åœ‹/æ¯”åˆ©æ™‚)', 'ç¨ç«‹æ—¥ (æ³¢è˜­)'],
      '11-15': ['å¾·èªå€ç¯€ (æ¯”åˆ©æ™‚)'],
      '12-06': ['èŠ¬è˜­ç¨ç«‹æ—¥ (èŠ¬è˜­)'],

      // Southeast Asia (SEA)
      '04-13': ['å®‹å¹²ç¯€ (æ³°åœ‹/æ±å—äº)'], // Usually 13-15
      '04-30': ['å—æ–¹è§£æ”¾æ—¥ (è¶Šå—)'],
      '08-09': ['åœ‹æ…¶æ—¥ (æ–°åŠ å¡)'],
      '08-17': ['ç¨ç«‹æ—¥ (å°å°¼)'],
      '08-31': ['åœ‹æ…¶æ—¥ (é¦¬ä¾†è¥¿äº)'],
      '09-02': ['åœ‹æ…¶æ—¥ (è¶Šå—)'],
      '12-05': ['çˆ¶è¦ªç¯€ (æ³°åœ‹)'],
      '12-10': ['æ†²æ³•æ—¥ (æ³°åœ‹)'],
  };

  const today = new Date();
  let currentMonth = today.getMonth();
  let currentYear = today.getFullYear();

  // Helper: Get Lunar Text
  function getLunarText(year, month, day) {
    // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
    if (typeof Solar === 'undefined') {
        console.error("Lunar library not loaded");
        return "åŠ è¼‰å¤±æ•—";
    }
    const solar = Solar.fromYmd(year, month, day);
    const lunar = solar.getLunar();
    // Convert simplified month/day to traditional if needed, 
    // but library usually outputs simplified. Simple mapping for key chars:
    // è…Š->è‡˜, å†¬->å†¬, æ­£->æ­£.
    // Let's rely on string replacement for common ones if strictly needed.
    // For now, keep library output but prefix with Traditional 'è¾²æ›†'.
    const monthText = lunar.getMonthInChinese() + 'æœˆ';
    const dayText = lunar.getDayInChinese();
    return `è¾²æ›† ${monthText}${dayText}`;
  }

  // Helper: Get Buddhist Info (Festivals + Fast Days)
  function getBuddhistInfo(year, month, day) {
    if (typeof Solar === 'undefined') return null;
    try {
        const solar = Solar.fromYmd(year, month, day);
        const lunar = solar.getLunar();
        
        const lMonth = Math.abs(lunar.getMonth());
        const lDay = lunar.getDay();
        const lunarKey = String(lMonth).padStart(2, '0') + '-' + String(lDay).padStart(2, '0');
        
        const markers = []; // ['å', 'å…­', 'æœ”', 'æœˆ']
        let festivalKey = buddhistFestivals[lunarKey] || null;
        let festival = festivalKey ? t(festivalKey) : null;
    
        // 1. Ten Fast Days (åæ–‹æ—¥): 1, 8, 14, 15, 18, 23, 24, 28, 29, 30
        const tenFastDays = [1, 8, 14, 15, 18, 23, 24, 28, 29, 30];
        if (tenFastDays.includes(lDay)) {
            markers.push('å');
        }
    
        // 2. Six Fast Days (å…­æ–‹æ—¥)
        if ([8, 14, 15, 23].includes(lDay)) markers.push('å…­');
        else if (lDay === 29) markers.push('å…­'); 
        else if (lDay === 30) markers.push('å…­'); 
        else if (lDay === 28) {
             try {
                if (lunar.next(2).getDay() === 1) {
                    markers.push('å…­');
                }
             } catch(e) {}
        }
    
        // 3. ShuoWang (æœ”æœ›): 1, 15
        if (lDay === 1 || lDay === 15) {
            markers.push('æœ”');
        }
    
        // 4. Month Fast (æœˆæ–‹): Month 1, 5, 9
        if ([1, 5, 9].includes(lMonth)) {
            markers.push('æœˆ');
        }
    
        // 5. User Events
        // Simple check for single-day events or start-dates for now. 
        // Ideally should handle ranges, but for this task, let's match startDate.
        // Format: YYYY-MM-DD
        const dateKey = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const allEvents = JSON.parse(localStorage.getItem('buddhist_calendar_events') || '[]');
        // Filter events for this day
        const dayEvents = allEvents.filter(e => {
            // Simple equality for start date. 
            // If you want range support: e.startDate <= dateKey && e.endDate >= dateKey
            return e.startDate === dateKey; 
        });
        
        // Construct Fast Days Text
        let fastDaysText = [];
        let fastDayDescriptions = [];
    
        if (markers.includes('å')) {
            fastDaysText.push(t('fast_day_ten'));
            fastDayDescriptions.push(t('desc_ten_fast'));
        }
        
        if (markers.includes('å…­')) {
            fastDaysText.push(t('fast_day_six'));
            
            // Detailed Logic for Six Fast Days Description
            if (lDay === 8) {
                fastDayDescriptions.push(t('desc_six_fast_8'));
            } else if (lDay === 14) {
                fastDayDescriptions.push(t('desc_six_fast_14'));
            } else if (lDay === 15) {
                fastDayDescriptions.push(t('desc_six_fast_15'));
            } else if (lDay === 23) {
                fastDayDescriptions.push(t('desc_six_fast_23'));
            } else if (lDay === 29) {
                let isSmallMonthEnd = false;
                try { if (lunar.next(1).getDay() === 1) isSmallMonthEnd = true; } catch(e){}
                
                if (isSmallMonthEnd) {
                    fastDayDescriptions.push(t('desc_six_fast_29_end'));
                } else {
                    fastDayDescriptions.push(t('desc_six_fast_29'));
                }
            } else if (lDay === 30) {
                fastDayDescriptions.push(t('desc_six_fast_30'));
            } else if (lDay === 28) {
                 // Handle small month end (28th as end)
                 try {
                    if (lunar.next(2).getDay() === 1) {
                         // Treated as 29th equivalent in small month
                         fastDayDescriptions.push(t('desc_six_fast_28_small'));
                    }
                 } catch(e) {}
            }
        }
        
        if (markers.includes('æœ”')) fastDaysText.push(t('fast_day_shuo'));
        if (markers.includes('æœˆ')) fastDaysText.push(t('fast_day_month'));
        
        const typeText = fastDaysText.length > 0 ? fastDaysText.join(' Â· ') : '';
        const descriptionText = fastDayDescriptions.length > 0 ? fastDayDescriptions.join('<br>') : '';
    
        const ganZhi = `${lunar.getYearInGanZhi()} ${lunar.getYearShengXiao()}å¹´ ${lunar.getMonthInGanZhi()}æœˆ ${lunar.getDayInGanZhi()}æ—¥`;
    
        return {
            festival: festival,
            ganZhi: ganZhi,
            markers: markers, // Array of chars
            title: festival ? festival : '',
            typeText: typeText,
            description: descriptionText,
            tags: [],
            jieqi: lunar.getJieQi(), // Add Solar Term
            events: dayEvents
        };
    } catch (e) {
        console.error('Buddhist Info Error', e);
        return null;
    }
  }

  // Helper: Render Event Card HTML
  function renderEventCard(e) {
    return `
    <div class="mt-3 p-3 bg-blue-50/50 rounded-xl border border-blue-100 shadow-sm relative group">
        <div class="flex justify-between items-start pr-8">
            <div class="font-bold text-blue-800 text-base">${e.title}</div>
            <div class="text-[10px] text-blue-400 bg-blue-100 px-1.5 py-0.5 rounded-full whitespace-nowrap">${e.isAllDay ? 'å…¨å¤©' : e.startDate.slice(5)}</div>
        </div>
        ${e.description ? `<div class="text-sm text-blue-600/80 mt-1 leading-relaxed">${e.description}</div>` : ''}
        
        <!-- Edit Button -->
        <a href="add_event.html?id=${e.id}" class="absolute top-3 right-3 text-blue-400 hover:text-blue-600 p-1 rounded-full hover:bg-blue-100 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
            </svg>
        </a>
    </div>
    `;
  }

  // Search Logic
  let currentFilter = 'all';
  let searchTimeout = null;
  let isSearchDataLoading = false;

  function loadSearchData() {
    if (typeof SEARCH_DATA !== 'undefined') return Promise.resolve();
    if (isSearchDataLoading) return new Promise(resolve => {
        const check = setInterval(() => {
            if (typeof SEARCH_DATA !== 'undefined') {
                clearInterval(check);
                resolve();
            }
        }, 100);
    });

    isSearchDataLoading = true;
    return new Promise((resolve, reject) => {
         const script = document.createElement('script');
         script.src = 'search_data.js?v=4';
         script.onload = () => {
            isSearchDataLoading = false;
            resolve();
        };
        script.onerror = () => {
            isSearchDataLoading = false;
            reject();
        };
        document.head.appendChild(script);
    });
  }

  const SUGGESTION_TERMS = [
      "ä½›æ³•æœ«ä¸–", "å› ç¼˜æœæŠ¥", "ä¸š", "çšˆä¾", 
      "æˆ’", "ç¦…å®š", "ä¾›å…»", "æ–¹ä¾¿", 
      "éšç¼˜", "å¿ƒæ³•", "åŠŸå¾·", "é¡»å¼¥å±±", 
      "æŸ“æ±¡", "æ™ºæ…§", "æ…ˆæ‚²", "å¾€ç”Ÿ"
  ];

  function renderSuggestions() {
      const chips = SUGGESTION_TERMS.map(term => 
        `<button onclick="searchForTerm('${term}')" class="px-3 py-1.5 bg-white border border-stone-200 rounded-full text-xs font-bold text-[#5c4033] shadow-sm active:bg-[#b35c1e] active:text-white transition-colors hover:border-[#b35c1e]">${term}</button>`
      ).join('');

      return `
        <div class="mt-4 px-2 animate-in fade-in duration-300">
            <div class="flex items-center gap-2 mb-4 text-[#8c7853] font-bold">
                <span class="text-lg">ğŸ’¡</span>
                <span>${t('term_explanation')}</span>
            </div>
            <div class="flex flex-wrap gap-2">
                ${chips}
            </div>
        </div>
      `;
  }

  function searchForTerm(term) {
      const input = document.getElementById('search-input');
      input.value = term;
      performSearch(term);
  }

  function performSearch(query) {
      clearTimeout(searchTimeout);
      const clearBtn = document.getElementById('search-clear');
      
      if (!query) {
          clearBtn.classList.add('hidden');
          document.getElementById('search-results').innerHTML = renderSuggestions();
          return;
      }
      
      clearBtn.classList.remove('hidden');

      // Debounce
      searchTimeout = setTimeout(() => {
          if (typeof SEARCH_DATA === 'undefined') {
              // Lazy Load
              document.getElementById('search-results').innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-[#8B4513]/40 gap-3">
                    <svg class="animate-spin h-8 w-8 text-[#8B4513]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm">${t('search_loading_db')}</span>
                </div>
              `;

              loadSearchData().then(() => {
                 performSearch(query);
              }).catch(() => {
                 document.getElementById('search-results').innerHTML = `<div class="text-center text-red-500 mt-10">${t('search_load_fail')}</div>`;
              });
              return;
          }

          const results = SEARCH_DATA.filter(item => {
              // Filter by category
              if (currentFilter !== 'all' && item.category !== currentFilter) return false;
              
              // Filter by query (case insensitive)
              const q = query.toLowerCase();
              const titleMatch = (item.title || "").toLowerCase().includes(q);
              
              // Extract text content if it's an object/wrapped
              let contentStr = "";
              if (typeof item.content === 'string') contentStr = item.content;
              else if (item.content && item.content.value) contentStr = item.content.value;
              
              const contentMatch = contentStr.toLowerCase().includes(q);
              
              return titleMatch || contentMatch;
          });

          renderSearchResults(results, query);
      }, 300);
  }

  function renderSearchResults(results, query) {
      const container = document.getElementById('search-results');
      if (results.length === 0) {
          container.innerHTML = `
            <div class="text-center text-stone-400 mt-10">
                <div class="text-4xl mb-2 opacity-50">ğŸ˜•</div>
                <p class="text-sm">${t('search_no_results')}</p>
            </div>
          `;
          return;
      }

      let html = '';
      results.forEach(item => {
          // Highlight match in title
          const title = highlightMatch(item.title, query);
          
          // Generate snippet
          let snippet = "";
          let contentStr = "";
          if (typeof item.content === 'string') contentStr = item.content;
          else if (item.content && item.content.value) contentStr = item.content.value;

          if (contentStr) {
              const idx = contentStr.toLowerCase().indexOf(query.toLowerCase());
              if (idx !== -1) {
                  const start = Math.max(0, idx - 20);
                  const end = Math.min(contentStr.length, idx + 60);
                  snippet = (start > 0 ? "..." : "") + contentStr.substring(start, end) + (end < contentStr.length ? "..." : "");
                  snippet = highlightMatch(snippet, query);
              } else {
                  snippet = contentStr.substring(0, 80) + "...";
              }
          }

          // Icon based on category
          let icon = 'ğŸ“„';
          let catLabel = t('cat_doc');
          let colorClass = 'text-stone-500';
          
          if (item.category === 'sutra') { icon = 'ğŸ“–'; catLabel = t('cat_sutra'); colorClass = 'text-amber-700'; }
          else if (item.category === 'master') { icon = 'ğŸ‘¤'; catLabel = t('cat_master'); colorClass = 'text-purple-700'; }
          else if (item.category === 'teaching') { icon = 'ğŸ“'; catLabel = t('cat_teaching'); colorClass = 'text-blue-700'; }
          else if (item.category === 'search_result') { icon = 'ğŸ”'; catLabel = t('cat_data'); colorClass = 'text-purple-700'; }

          html += `
            <div onclick="openReader('${item.id}')" class="bg-white/40 backdrop-blur-md rounded-2xl p-4 shadow-sm border border-white/50 ring-1 ring-white/30 active:scale-[0.98] transition-all cursor-pointer hover:shadow-lg group">
                <div class="flex items-start gap-3">
                    <div class="mt-1 text-xl drop-shadow-sm group-hover:scale-110 transition-transform">${icon}</div>
                    <div class="flex-1 overflow-hidden">
                        <div class="font-bold text-[#5c4033] text-sm truncate mb-1 group-hover:text-[#b35c1e] transition-colors">${title}</div>
                        <div class="text-xs text-stone-400 mb-2 flex items-center gap-2">
                            <span class="${colorClass} bg-white/50 px-2 py-0.5 rounded-md border border-white/40 shadow-sm backdrop-blur-sm">${catLabel}</span>
                            ${item.type === 'docx' ? '<span class="text-blue-500 font-bold">DOCX</span>' : ''}
                        </div>
                        <div class="text-xs text-stone-600 leading-relaxed line-clamp-2 font-serif opacity-80 group-hover:opacity-100 transition-opacity">${snippet}</div>
                    </div>
                </div>
            </div>
          `;
      });
      container.innerHTML = html;
  }

  function highlightMatch(text, query) {
      if (!query || !text) return text;
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<span class="bg-yellow-200/80 text-stone-900 font-bold rounded-sm px-0.5">$1</span>');
  }

  function clearSearch() {
      document.getElementById('search-input').value = '';
      performSearch('');
  }

  function filterSearch(filter) {
      currentFilter = filter;
      // Update buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
          if (btn.dataset.filter === filter) {
              // Active: Gradient + Shadow
              btn.className = 'filter-btn px-4 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap bg-gradient-to-r from-[#b35c1e] to-[#d68c45] text-white shadow-md border-transparent transform scale-105';
          } else {
              // Inactive: Glass
              btn.className = 'filter-btn px-4 py-1.5 rounded-full text-xs font-medium transition-all whitespace-nowrap bg-white/40 text-stone-600 border border-white/50 hover:bg-white/60 hover:text-stone-800';
          }
      });
      // Rerun search
      performSearch(document.getElementById('search-input').value);
  }

  function openReader(id) {
      // Navigate to reader with ID
      // If we are in local file system, we might need to handle the path carefully
      // But reader.html expects ?file=...
      // We can pass the ID as the file param, and update reader.html to look it up in SEARCH_DATA
      
      let url = `reader.html?file=${encodeURIComponent(id)}`;
      
      // Check if we are coming from Search Tab
      const searchTab = document.getElementById('tab-search');
      const isSearchActive = searchTab && !searchTab.classList.contains('hidden');
      
      if (isSearchActive) {
          url += '&from=search';
          // Preserve search query
          const searchInput = document.getElementById('search-input');
          if (searchInput && searchInput.value.trim()) {
              url += `&query=${encodeURIComponent(searchInput.value.trim())}`;
          }
      } else {
          // Assume Dharma tab if not search
          url += '&from=dharma';
      }
      
      window.location.href = url;
  }

  // Render Calendar Logic
  function renderCalendar() {
    const header = document.getElementById('calendar-header');
    const grid = document.getElementById('calendar-grid');
    const weekdayHeader = document.getElementById('weekday-header');

    grid.innerHTML = '';
    
    // Render Weekday Header
    if(weekdayHeader) {
        weekdayHeader.innerHTML = '';
        const weekDays = t('weekdays');
        weekDays.forEach(d => {
            const el = document.createElement('div');
            el.innerText = d;
            weekdayHeader.appendChild(el);
        });
    }

    header.innerText = `${currentYear} å¹´ ${currentMonth + 1} æœˆ`;
    
    // Update App Header Title (Buddhist Year)
    // Buddhist Year = Gregorian Year + Offset
    const offset = parseInt(localStorage.getItem('buddhist_era_offset') || 544);
    const buddhistYear = currentYear + offset;
    const appTitle = document.getElementById('app-title');
    if (appTitle) {
        appTitle.innerHTML = `${t('app_title')} ${buddhistYear}`;
    }

    const firstDay = new Date(currentYear, currentMonth, 1).getDay(); // 0 is Sunday
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    // Empty cells for days before the 1st
    for (let i = 0; i < firstDay; i++) {
      grid.appendChild(document.createElement('div'));
    }

    // Days
    for (let d = 1; d <= daysInMonth; d++) {
      const cell = document.createElement('div');
      
      // Styling: Minimalist - No default borders/backgrounds
      // Added 'day-cell' for selection logic
      cell.className = 'day-cell relative flex flex-col items-center justify-start min-h-[75px] py-1 rounded-xl cursor-pointer transition-all duration-200 active:scale-95 select-none group';
      
      const isToday = d === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
      
      // Highlight Today: Filled Color (Reference style)
      if (isToday) {
        // Solid accent color for Today
        cell.classList.add('bg-[#b35c1e]', 'text-white', 'shadow-md');
      } else {
        // Normal days: Transparent, hover effect
        cell.classList.add('text-stone-700', 'hover:bg-stone-100/50');
      }

      // 1. Top Row: Markers Left | Day Number | Markers Right
      const topRow = document.createElement('div');
      topRow.className = 'w-full flex justify-between items-start px-0.5 mb-0.5'; // Reduced padding
      
      const leftMarkers = document.createElement('div');
      leftMarkers.className = 'flex flex-col gap-0.5 text-[8px] leading-none';
      
      const rightMarkers = document.createElement('div');
      rightMarkers.className = 'flex flex-col gap-0.5 text-[8px] leading-none';
      
      // Get Info
      const info = getBuddhistInfo(currentYear, currentMonth + 1, d);
      
      // Populate Markers
      if (info && info.markers) {
          info.markers.forEach(m => {
              const badge = document.createElement('div');
              badge.innerText = m;
              if (m === 'æœˆ' || m === 'æœ”') {
                  badge.className = 'w-3.5 h-3.5 flex items-center justify-center bg-stone-200/80 backdrop-blur-sm text-stone-600 rounded-md shadow-sm';
              } else {
                  // 'å', 'å…­'
                  // Add border-white for contrast if isToday
                  badge.className = `w-3.5 h-3.5 flex items-center justify-center bg-gradient-to-br from-[#b35c1e] to-[#d68c45] text-white rounded-full shadow-sm opacity-90 ${isToday ? 'border border-white/40' : 'border border-[#b35c1e]/20'}`;
              }
              if (['æœˆ', 'æœ”'].includes(m)) leftMarkers.appendChild(badge);
              else rightMarkers.appendChild(badge);
          });
      }

      // Day Number (Center)
      const num = document.createElement('div');
      num.innerText = d;
      
      const globalFests = getGlobalFestivals(currentYear, currentMonth + 1, d);
      const hasGlobalFest = globalFests.length > 0;
      
      // Number Styling
      if (isToday) {
          num.className = 'text-lg leading-none mx-auto font-serif font-bold drop-shadow-sm';
      } else if (hasGlobalFest) {
          num.className = 'text-lg leading-none font-bold mx-auto font-serif text-indigo-600';
      } else {
          num.className = 'text-lg leading-none font-medium mx-auto font-serif opacity-90 group-hover:opacity-100';
      }
      
      topRow.appendChild(leftMarkers);
      topRow.appendChild(num);
      topRow.appendChild(rightMarkers);
      cell.appendChild(topRow);

      // 2. Middle Row: Solar Term OR Lunar Text
      const midRow = document.createElement('div');
      midRow.className = 'flex items-center justify-center gap-1 mb-0.5 w-full relative';

      const lunarText = getLunarText(currentYear, currentMonth + 1, d);
      let displayText = lunarText.replace('è¾²æ›† ', '').replace(/.*æœˆ/, '');
      
      const lunarDiv = document.createElement('div');
      
      if (info && info.jieqi) {
          displayText = info.jieqi;
          // Solar term highlight
          lunarDiv.className = isToday ? 'text-[10px] text-orange-100 font-bold' : 'text-[10px] text-[#b35c1e] font-bold';
      } else {
          lunarDiv.className = isToday ? 'text-[10px] text-orange-100/90 font-medium' : 'text-[10px] text-stone-500/80 font-medium';
      }
      
      lunarDiv.innerText = displayText;

      if (info && info.festival) {
          // Festival text highlight
          lunarDiv.className = isToday ? 'text-[10px] text-white font-bold' : 'text-[10px] text-[#b35c1e] font-bold';
      }
      
      midRow.appendChild(lunarDiv);
      cell.appendChild(midRow);
      
      // 3. Bottom Row: Festival + Event
      const bottomContainer = document.createElement('div');
      bottomContainer.className = 'w-full flex flex-col gap-0.5 mt-auto px-0.5';

      // Festival Text
      if (info && info.festival) {
          const festDiv = document.createElement('div');
          festDiv.innerText = info.festival;
          // Adjust text color for contrast if isToday
          festDiv.className = isToday 
            ? 'text-[8px] text-white/90 leading-tight text-center w-full truncate font-bold'
            : 'text-[8px] text-[#b35c1e] leading-tight text-center w-full truncate font-bold opacity-90';
          bottomContainer.appendChild(festDiv);
      }

      // Event Marker
      if (info && info.events && info.events.length > 0) {
          const eventDiv = document.createElement('div');
          eventDiv.innerText = info.events[0].title;
          // Make event pill smaller/cleaner
          eventDiv.className = 'text-[8px] text-blue-700 bg-blue-50/80 backdrop-blur-sm border border-blue-100 rounded-sm px-0.5 py-0.5 w-full truncate text-center shadow-sm';
          bottomContainer.appendChild(eventDiv);
      }

      cell.appendChild(bottomContainer);

      // Click Handler
      cell.onclick = function () {
        // UI Selection Logic
        document.querySelectorAll('.day-cell').forEach(c => {
             // Reset selection styles
             c.classList.remove(
                'ring-2', 'ring-[#b35c1e]', 'ring-white', 'ring-offset-2', 'ring-offset-[#b35c1e]', 
                'bg-orange-100', 
                'bg-white/20', 'backdrop-blur-sm', 'border', 'border-white/80', 'shadow-[inset_0_1px_0_0_rgba(255,255,255,0.8)]'
             );
        });

        // Apply selection style
        if (isToday) {
             // Today: White ring for contrast against filled orange
             cell.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#b35c1e]'); 
        } else {
             // Glassy Selection: Transparent with white highlight border
             // bg-white/20: Subtle fill
             // border-white/80: Bright glass edge
             // shadow-inset: Top highlight reflection
             cell.classList.add('bg-white/20', 'backdrop-blur-sm', 'border', 'border-white/80', 'shadow-[inset_0_1px_0_0_rgba(255,255,255,0.8)]');
        }

        renderDayInfo(currentYear, currentMonth + 1, d);
        // document.getElementById('day-info-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
      };

      grid.appendChild(cell);
    }

    // Apply special event styles after calendar is rendered
    applySpecialEvents(currentYear, currentMonth);
  }

  // Helper: Get Nth Weekday of Month
  function getNthWeekday(year, month, weekday, n) {
      const date = new Date(year, month - 1, 1);
      let count = 0;
      while (date.getMonth() === month - 1) {
          if (date.getDay() === weekday) {
              count++;
              if (count === n) return date.getDate();
          }
          date.setDate(date.getDate() + 1);
      }
      return null;
  }

  // Helper: Get Easter Date (Meeus/Jones/Butcher's Algorithm)
  function getEaster(year) {
      const f = Math.floor;
      const G = year % 19;
      const C = f(year / 100);
      const H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30;
      const I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11));
      const J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7;
      const L = I - J;
      const month = 3 + f((L + 40) / 44);
      const day = L + 28 - 31 * f(month / 4);
      return { month, day };
  }

  // Helper: Get Global Festivals
  function getGlobalFestivals(year, month, day) {
      const key = String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
      let list = SOLAR_FESTIVALS[key] ? [...SOLAR_FESTIVALS[key]] : [];

      // Variable Holidays
      // Mother's Day: May 2nd Sun
      if (month === 5 && day === getNthWeekday(year, 5, 0, 2)) list.push('æ¯è¦ªç¯€ (åœ‹éš›)');
      // Father's Day: Jun 3rd Sun
      if (month === 6 && day === getNthWeekday(year, 6, 0, 3)) list.push('çˆ¶è¦ªç¯€ (åœ‹éš›)');
      // US Thanksgiving: Nov 4th Thu
      if (month === 11 && day === getNthWeekday(year, 11, 4, 4)) list.push('æ„Ÿæ©ç¯€ (åŒ—ç¾)');
      // US Labor Day: Sep 1st Mon
      if (month === 9 && day === getNthWeekday(year, 9, 1, 1)) list.push('å‹å‹•ç¯€ (åŒ—ç¾)');
      
      // Japan Happy Mondays
      if (month === 1 && day === getNthWeekday(year, 1, 1, 2)) list.push('æˆäººä¹‹æ—¥ (æ—¥æœ¬)');
      if (month === 7 && day === getNthWeekday(year, 7, 1, 3)) list.push('æµ·ä¹‹æ—¥ (æ—¥æœ¬)');
      if (month === 9 && day === getNthWeekday(year, 9, 1, 3)) list.push('æ•¬è€ä¹‹æ—¥ (æ—¥æœ¬)');
      if (month === 10 && day === getNthWeekday(year, 10, 1, 2)) list.push('é«”è‚²ä¹‹æ—¥ (æ—¥æœ¬)');

      // European Variable Holidays (Easter Based)
      const easter = getEaster(year);
      const checkDate = new Date(year, month - 1, day);
      const easterDate = new Date(year, easter.month - 1, easter.day);
      
      // Calculate difference in days
      const diffTime = checkDate.getTime() - easterDate.getTime();
      const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays === -2) list.push('è€¶ç©Œå—é›£æ—¥ (æ­æ´²)');
      if (diffDays === 0) list.push('å¾©æ´»ç¯€ (æ­æ´²)');
      if (diffDays === 1) list.push('å¾©æ´»ç¯€æ˜ŸæœŸä¸€ (æ­æ´²)');
      if (diffDays === 39) list.push('è€¶ç©Œå‡å¤©ç¯€ (æ­æ´²)');
      if (diffDays === 49) list.push('è–éˆé™è‡¨ç¯€ (æ­æ´²)');
      if (diffDays === 50) list.push('è–éˆé™è‡¨é€±ä¸€ (æ­æ´²)');
      if (diffDays === 60) list.push('åŸºç£è–é«”è–è¡€ç¯€ (æ­æ´²)');

      // Sweden: Midsummer (Sat between June 20-26)
      if (month === 6 && day >= 20 && day <= 26 && checkDate.getDay() === 6) {
          list.push('ä»²å¤ç¯€ (ç‘å…¸)');
      }
      // Sweden: All Saints (Sat between Oct 31-Nov 6)
      if (month === 10 && day === 31 && checkDate.getDay() === 6) list.push('è¬è–ç¯€ (ç‘å…¸)'); // Rare case 10/31 is Sat
      if (month === 11 && day <= 6 && checkDate.getDay() === 6) list.push('è¬è–ç¯€ (ç‘å…¸)');

      // Lunar / Traditional Chinese Festivals
      try {
        if (typeof Solar !== 'undefined') {
            const solar = Solar.fromYmd(year, month, day);
            const lunar = solar.getLunar();
            const lm = Math.abs(lunar.getMonth());
            const ld = lunar.getDay();
            const jq = lunar.getJieQi();
            
            if (lm === 1 && ld === 1) list.push('æ˜¥ç¯€ (ä¸­åœ‹)');
            if (lm === 1 && ld === 15) list.push('å…ƒå®µç¯€ (ä¸­åœ‹)');
            if (lm === 5 && ld === 5) list.push('ç«¯åˆç¯€ (ä¸­åœ‹)');
            if (lm === 7 && ld === 7) list.push('ä¸ƒå¤•ç¯€ (ä¸­åœ‹)');
            if (lm === 7 && ld === 15) list.push('ä¸­å…ƒç¯€ (ä¸­åœ‹)');
            if (lm === 8 && ld === 15) list.push('ä¸­ç§‹ç¯€ (ä¸­åœ‹)');
            if (lm === 9 && ld === 9) list.push('é‡é™½ç¯€ (ä¸­åœ‹)');
            if (lm === 12 && ld === 8) list.push('è‡˜å…«ç¯€ (ä¸­åœ‹)');
            
            // Qingming (Solar Term)
            if (jq === 'æ¸…æ˜') list.push('æ¸…æ˜ç¯€ (ä¸­åœ‹)');
        }
      } catch (e) {
        console.error('Lunar fest calc error', e);
      }

      return list;
  }

  // Render Day Info (Replaces Modal)
  function renderDayInfo(year, month, day) {
      const today = new Date();
      // Reset time for accurate comparison
      const isToday = (year === today.getFullYear() && month === (today.getMonth() + 1) && day === today.getDate());
      
      // Title
      const titleText = isToday ? t('info_today') : t('info_day'); 

      // Safety check for Lunar Library
      if (typeof Solar === 'undefined') {
           const html = `
             <div class="flex items-center justify-between mb-2">
                 <div class="text-[#a67c52] text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                   <span class="w-1.5 h-1.5 rounded-full bg-[#a67c52]"></span>
                   ${titleText}
                 </div>
                 <div class="text-sm font-bold text-[#5c4033] font-serif">${year}å¹´ ${month}æœˆ ${day}æ—¥</div>
             </div>
             <div class="p-4 bg-stone-50 text-stone-600 text-sm rounded-xl text-center">
                 ${t('loading_lunar')}<br>
                 <span class="text-xs opacity-70">${t('loading_timeout')}</span>
             </div>
           `;
           const el = document.getElementById('day-info-content');
           if(el) {
                el.innerHTML = html;
                el.classList.remove('opacity-0');
           }
           return;
      }

      try {
          const solar = Solar.fromYmd(year, month, day);
          const lunar = solar.getLunar();
          
          // Buddhist Info
          const info = getBuddhistInfo(year, month, day);
          
          // Helper to format Buddhist info card
          let infoHtml = '';
          if (info && (info.title || info.typeText)) {
              infoHtml = `
                   <div class="mt-4 p-4 bg-orange-50/60 backdrop-blur-md rounded-2xl border border-orange-100/50 shadow-sm ring-1 ring-orange-100/30">
                     <div class="font-bold text-[#b35c1e] mb-1 flex items-center gap-2">
                         <span class="text-lg">ğŸ•¯ï¸</span>
                         <div>
                            ${info.title ? info.title : t('today_fast_title')} 
                            <span class="block text-xs font-normal opacity-80 mt-0.5 text-[#b35c1e]/70">${info.typeText}</span>
                         </div>
                     </div>
                     <div class="text-xs text-[#8c6b4a] mt-2 text-justify leading-relaxed font-serif">${info.description ? info.description : (info.tags.length > 0 ? t('recommendation_prefix') + info.tags.join('ã€') : t('default_recommendation'))}</div>
                   </div>`;
          } else {
              // Only show 'No special info' if there are no global festivals either (logic handled below)
              infoHtml = `<div class="mt-4 text-stone-400 text-sm hidden" id="no-info-placeholder">${t('today_no_special')}</div>`;
          }
    
          // Global Festivals
          const globalFestivals = getGlobalFestivals(year, month, day);
          let globalFestHtml = '';
          if (globalFestivals.length > 0) {
              // Compressed: Single line
              globalFestHtml = `
                   <div class="mt-2 px-3 py-2 bg-indigo-50/60 backdrop-blur-md rounded-xl border border-indigo-100/50 shadow-sm flex items-center gap-2">
                     <span class="text-lg shrink-0">ğŸŒ</span>
                     <div class="text-xs font-bold text-indigo-800 truncate leading-none pt-0.5">${globalFestivals.join(' Â· ')}</div>
                   </div>`;
          }
    
          // If both are empty, show placeholder
          if (!infoHtml.includes('bg-orange-50') && globalFestivals.length === 0) {
               infoHtml = `<div class="mt-4 text-stone-400 text-sm text-center py-4 bg-white/20 rounded-xl border border-white/30 backdrop-blur-sm">${t('today_no_special')}</div>`;
          } else if (infoHtml.includes('hidden')) {
               infoHtml = ''; // Clear hidden placeholder if we have global festivals
          }
    
          // Append Global Festivals
          if (globalFestHtml) {
              infoHtml += globalFestHtml;
          }
    
          if (info && info.events && info.events.length > 0) {
              infoHtml += info.events.map(e => renderEventCard(e)).join('');
          }
      
          // Almanac Data Preparation
          const jieqi = lunar.getJieQi();
          const yiList = lunar.getDayYi();
          const jiList = lunar.getDayJi();
          const yiStr = yiList.length > 0 ? yiList.slice(0, 10).join('ã€') + (yiList.length > 10 ? '...' : '') : t('nothing_suitable');
          const jiStr = jiList.length > 0 ? jiList.slice(0, 10).join('ã€') + (jiList.length > 10 ? '...' : '') : t('nothing_taboo');
          
          // WuXing Logic
          let wuxingStr = '';
          try {
              const gan = lunar.getDayGan();
              const zhi = lunar.getDayZhi();
              const wxGan = {'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´'};
              const wxZhi = {'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'};
              if(wxGan[gan] && wxZhi[zhi]) {
                  wuxingStr = `${t('gan_label')}[${gan}]${t('belongs_to')}${wxGan[gan]} Â· ${t('zhi_label')}[${zhi}]${t('belongs_to')}${wxZhi[zhi]}`;
              }
          } catch(e) {}
      
          // Construct Main HTML
          const html = `
            <div class="flex items-center justify-between mb-2">
                <div class="text-[#a67c52] text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                  <span class="w-1.5 h-1.5 rounded-full bg-[#a67c52]"></span>
                  ${titleText}
                </div>
                <!-- Replaced Date with WuXing -->
                <div class="text-[10px] font-bold text-[#8c7853] bg-[#f8c390]/20 px-2 py-1 rounded-lg border border-[#f8c390]/30">${wuxingStr || ''}</div>
            </div>
            
            <!-- Lunar Header (Compact) -->
          <div class="flex items-center gap-2 mb-1 pb-1 border-b border-[#b35c1e]/10 font-serif text-[#5c4033] flex-wrap text-sm">
               <span class="font-bold text-lg">${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}</span>
               <span class="text-xs opacity-80 flex gap-2 items-center ml-2">
                  <span>${lunar.getYearInGanZhi()}å¹´ [${lunar.getYearShengXiao()}]</span>
                  <span>â€¢</span>
                  <span>${lunar.getMonthInGanZhi()}æœˆ</span>
                  <span>â€¢</span>
                  <span>${lunar.getDayInGanZhi()}æ—¥</span>
               </span>
               ${jieqi ? `<span class="ml-auto px-3 py-0.5 bg-gradient-to-r from-[#b35c1e] to-[#d68c45] text-white text-[10px] rounded-full font-bold shadow-sm">${jieqi}</span>` : ''}
          </div>
    
          <!-- Yi / Ji (Merged & Compressed) -->
            <div class="mt-2 bg-stone-50/60 backdrop-blur-md rounded-xl p-3 border border-stone-100 shadow-sm font-serif">
                <!-- Yi -->
                <div class="flex items-start gap-3 mb-2">
                    <div class="shrink-0 w-6 h-6 rounded-full bg-emerald-500 text-white flex items-center justify-center text-xs shadow-sm">${t('yi_label')}</div>
                    <div class="text-xs text-stone-700 leading-relaxed pt-1">${yiStr}</div>
                </div>
                <!-- Divider -->
                <div class="h-px bg-stone-200 w-full my-2"></div>
                <!-- Ji -->
                <div class="flex items-start gap-3">
                    <div class="shrink-0 w-6 h-6 rounded-full bg-rose-500 text-white flex items-center justify-center text-xs shadow-sm">${t('ji_label')}</div>
                    <div class="text-xs text-stone-700 leading-relaxed pt-1">${jiStr}</div>
                </div>
            </div>
      
            <!-- Buddhist Info -->
            ${infoHtml}
          `;
      
          const card = document.getElementById('day-info-card');
          if(card) {
               card.innerHTML = html;
          }
      } catch (e) {
          console.error('Render Day Info Error', e);
          const card = document.getElementById('day-info-card');
          if(card) {
               card.innerHTML = `<div class="p-4 text-center text-red-500 text-sm">${t('error_data')}: ${e.message}<br><span class="text-xs text-stone-500">${t('retry_refresh')}</span></div>`;
          }
      }
  }

  // Show TongSheng Modal - REMOVED
  function showTongSheng(year, month, day) {
     // Legacy stub removed, calling renderDayInfo instead
     renderDayInfo(year, month, day);
  }

  // Change Month Logic
  function changeMonth(offset) {
    currentMonth += offset;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    } else if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar();
  }

  // Switch Tab Logic
  function switchTab(tabId) {
    // 1. Switch Content
    document.querySelectorAll('.tab-content').forEach(el => {
      el.classList.add('hidden');
      el.classList.remove('block');
    });
    
    const target = document.getElementById('tab-' + tabId);
    if(target) {
        target.classList.remove('hidden');
        target.classList.add('block');
    }

    // 2. Update Mobile Nav Buttons
    // Reset all mobile buttons
    document.querySelectorAll('#btn-tab-calendar, #btn-tab-search, #btn-tab-dharma, #btn-tab-diet, #btn-tab-chant').forEach(btn => {
        btn.classList.remove('text-[#b35c1e]', 'font-bold');
        btn.classList.add('text-[#8B4513]/60');
        const icon = btn.querySelector('span:first-child');
        if(icon) icon.classList.add('opacity-80');
    });

    // Activate current mobile button
    const mobileBtn = document.getElementById('btn-tab-' + tabId);
    if(mobileBtn) {
        mobileBtn.classList.remove('text-[#8B4513]/60');
        mobileBtn.classList.add('text-[#b35c1e]', 'font-bold');
        const icon = mobileBtn.querySelector('span:first-child');
        if(icon) icon.classList.remove('opacity-80');
    }

    // 3. Update Desktop Nav Buttons
    // Reset all desktop buttons
    document.querySelectorAll('#nav-desktop-calendar, #nav-desktop-search, #nav-desktop-dharma, #nav-desktop-diet, #nav-desktop-chant').forEach(btn => {
        btn.classList.remove('bg-white/60', 'text-[#b35c1e]', 'shadow-sm');
        btn.classList.add('text-[#8c7853]', 'hover:bg-white/50');
    });

    // Activate current desktop button
    const desktopBtn = document.getElementById('nav-desktop-' + tabId);
    if(desktopBtn) {
        desktopBtn.classList.remove('text-[#8c7853]', 'hover:bg-white/50');
        desktopBtn.classList.add('bg-white/60', 'text-[#b35c1e]', 'shadow-sm');
    }

    // Special logic for Diet tab
    if (tabId === 'diet') {
        fetchZenMeal(false);
    }
    
    // Scroll to top
    if(window.innerWidth >= 1024) {
        const main = document.querySelector('main');
        if(main) main.scrollTo({top:0, behavior:'smooth'});
    } else {
        window.scrollTo({top:0, behavior:'smooth'});
    }
  }

  // Counter Logic
  let count = 0;
  const todayKey = new Date().toISOString().split('T')[0];
  const storageKey = 'buddhist_counter';
  const historyKey = 'buddhist_counter_history';

  function initCounter() {
    const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
    if (data[todayKey]) {
        count = data[todayKey];
    } else {
        count = 0;
    }
    updateDisplay();
    updateHistory();
  }
  
  function updateCounter(change) {
    count += change;
    if (count < 0) count = 0;
    
    // Save temp
    const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
    data[todayKey] = count;
    localStorage.setItem(storageKey, JSON.stringify(data));
    
    updateDisplay();
  }
  
  function saveCounterRecord() {
      if (count === 0) return;
      if(!confirm(t('counter_save_confirm'))) return;
      
      // Create Record
      const record = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          count: count
      };

      // Save to History
      const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
      history.unshift(record); // Add to top
      localStorage.setItem(historyKey, JSON.stringify(history));

      // Reset Current
      count = 0;
      updateCounter(0); 
      
      updateHistory();
  }
  
  function updateDisplay() {
      const el = document.getElementById('counter-display');
      if(el) el.innerText = count.toLocaleString();
  }
  
  function updateHistory() {
      const historyEl = document.getElementById('counter-history');
      if(!historyEl) return;
      
      const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
      
      if (history.length === 0) {
          historyEl.innerHTML = `<div class="text-center text-stone-400 py-4 text-xs">${t('history_empty')}</div>`;
          return;
      }

      let html = '<div class="space-y-2 max-h-40 overflow-y-auto pr-1">';
      history.forEach(rec => {
          const date = new Date(rec.timestamp);
          const dateStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
          const timeStr = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
          
          html += `
            <div class="flex items-center justify-between text-xs py-2 border-b border-stone-100 last:border-0">
                <div class="text-stone-500">
                    <span class="font-medium mr-1">${dateStr}</span>
                    <span class="text-stone-400">${timeStr}</span>
                </div>
                <div class="text-[#b35c1e] font-bold tabular-nums">${rec.count.toLocaleString()}</div>
            </div>
          `;
      });
      html += '</div>';
      
      historyEl.innerHTML = html;
  }

  function renderStats() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    
    // 1. Chant Data (Aggregate History + Current)
    const chantHistory = JSON.parse(localStorage.getItem('buddhist_counter_history') || '[]');
    const chantCurrent = JSON.parse(localStorage.getItem('buddhist_counter') || '{}');
    
    const chantDailyMap = {};
    
    // Add History
    chantHistory.forEach(rec => {
        const d = new Date(rec.timestamp);
        if(d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
            const day = d.getDate();
            chantDailyMap[day] = (chantDailyMap[day] || 0) + rec.count;
        }
    });

    // Add Current (Unsaved)
    Object.keys(chantCurrent).forEach(dateKey => {
        const d = new Date(dateKey);
        // Only if valid date and matches current month
        if(!isNaN(d.getTime()) && d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
            const day = d.getDate();
            chantDailyMap[day] = (chantDailyMap[day] || 0) + chantCurrent[dateKey];
        }
    });

    let maxChant = 0;
    const chantDaily = [];
    
    for(let i=1; i<=daysInMonth; i++) {
        const val = chantDailyMap[i] || 0;
        chantDaily.push({day: i, val: val});
        if(val > maxChant) maxChant = val;
    }
    
    const chantContainer = document.getElementById('chart-chant');
    if(chantContainer) {
        let html = '';
        chantDaily.forEach(d => {
            const hPercent = maxChant > 0 ? (d.val / maxChant) * 100 : 0;
            const h = Math.max(hPercent, 5); 
            const color = d.val > 0 ? 'bg-[#f8c390]' : 'bg-stone-100';
            html += `
                <div class="flex-1 flex flex-col items-center group relative">
                    <div class="w-full rounded-t-sm ${color} transition-all duration-500 hover:bg-[#b35c1e]" style="height: ${h}%"></div>
                    ${d.day % 5 === 0 ? `<div class="text-[8px] text-[#8B4513]/40 mt-1 absolute -bottom-4 transform -translate-x-1/2 left-1/2">${d.day}</div>` : ''}
                    <div class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-stone-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-10 shadow-lg">
                        ${d.day}${t('date_day_suffix') || 'æ—¥'}: ${d.val}
                    </div>
                </div>
            `;
        });
        chantContainer.innerHTML = html;
    }

    // 2. Meditation Data
    const medHistory = JSON.parse(localStorage.getItem('meditation_session_history') || '[]');
    const medDailyMap = {};
    medHistory.forEach(rec => {
        const d = new Date(rec.timestamp);
        if(d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
            const day = d.getDate();
            const mins = Math.round(rec.duration / 60);
            medDailyMap[day] = (medDailyMap[day] || 0) + mins;
        }
    });
    
    let maxMed = 0;
    const medDaily = [];
    for(let i=1; i<=daysInMonth; i++) {
        const val = medDailyMap[i] || 0;
        medDaily.push({day: i, val: val});
        if(val > maxMed) maxMed = val;
    }
    
    const medContainer = document.getElementById('chart-meditation');
    if(medContainer) {
        let html = '';
        medDaily.forEach(d => {
            const hPercent = maxMed > 0 ? (d.val / maxMed) * 100 : 0;
            const h = Math.max(hPercent, 5);
            const color = d.val > 0 ? 'bg-emerald-300' : 'bg-stone-100';
            html += `
                <div class="flex-1 flex flex-col items-center group relative">
                    <div class="w-full rounded-t-sm ${color} transition-all duration-500 hover:bg-emerald-600" style="height: ${h}%"></div>
                    ${d.day % 5 === 0 ? `<div class="text-[8px] text-[#8B4513]/40 mt-1 absolute -bottom-4 transform -translate-x-1/2 left-1/2">${d.day}</div>` : ''}
                    <div class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-stone-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-10 shadow-lg">
                        ${d.day}${t('date_day_suffix') || 'æ—¥'}: ${d.val} ${t('unit_min')}
                    </div>
                </div>
            `;
        });
        medContainer.innerHTML = html;
    }
  }

  // Meditation Logic
  let meditationState = 'idle'; // idle, running, paused
  let meditationStartTime = null;
  let meditationElapsedTime = 0; // seconds accumulated before current run
  let meditationInterval = null;
  let meditationSoundEnabled = true;
  let meditationAlertPlayed = false;

  function switchChantMode(mode) {
      const btnCounter = document.getElementById('btn-mode-counter');
      const btnMeditation = document.getElementById('btn-mode-meditation');
      const btnStats = document.getElementById('btn-mode-stats');
      
      const viewCounter = document.getElementById('mode-counter');
      const viewMeditation = document.getElementById('mode-meditation');
      const viewStats = document.getElementById('mode-stats');

      // Reset all buttons
      [btnCounter, btnMeditation, btnStats].forEach(btn => {
          if(btn) {
              btn.classList.remove('bg-white', 'text-[#b35c1e]', 'shadow-sm');
              btn.classList.add('text-stone-500');
          }
      });
      
      // Hide all views
      [viewCounter, viewMeditation, viewStats].forEach(view => {
          if(view) view.classList.add('hidden');
      });

      // Activate selected
      if (mode === 'counter') {
          if(btnCounter) {
              btnCounter.classList.add('bg-white', 'text-[#b35c1e]', 'shadow-sm');
              btnCounter.classList.remove('text-stone-500');
          }
          if(viewCounter) viewCounter.classList.remove('hidden');
          updateHistory(); 
      } else if (mode === 'meditation') {
          if(btnMeditation) {
              btnMeditation.classList.add('bg-white', 'text-[#b35c1e]', 'shadow-sm');
              btnMeditation.classList.remove('text-stone-500');
          }
          if(viewMeditation) viewMeditation.classList.remove('hidden');
          if(typeof renderMeditationHistory === 'function') renderMeditationHistory();
      } else if (mode === 'stats') {
          if(btnStats) {
              btnStats.classList.add('bg-white', 'text-[#b35c1e]', 'shadow-sm');
              btnStats.classList.remove('text-stone-500');
          }
          if(viewStats) viewStats.classList.remove('hidden');
          renderStats();
      }
  }

  function updateTimerDisplay() {
      // Calculate total seconds
      let totalSeconds = meditationElapsedTime;
      if (meditationState === 'running' && meditationStartTime) {
          totalSeconds += Math.floor((Date.now() - meditationStartTime) / 1000);
      }

      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      
      let timeStr = '';
      if (h > 0) {
           timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      } else {
           timeStr = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      }
      
      const display = document.getElementById('timer-display');
      if(display) display.innerText = timeStr;
          
      // Update Circle Progress (1 hour loop)
      const circle = document.getElementById('timer-progress');
      if (circle) {
          const circumference = 2 * Math.PI * 46; 
          // 3600 seconds = 1 full circle
          let progress = (totalSeconds % 3600) / 3600;
          
          circle.style.strokeDashoffset = circumference * (1 - progress);
      }
      
      checkMeditationAlert(totalSeconds);
  }
  
  function checkMeditationAlert(totalSeconds) {
      if (meditationAlertPlayed) return;
      
      const alertInput = document.getElementById('meditation-alert-input');
      if (!alertInput || !alertInput.value) return;
      
      const [targetH, targetM] = alertInput.value.split(':').map(Number);
      const now = new Date();
      
      if (now.getHours() === targetH && now.getMinutes() === targetM) {
          playBellSound();
          meditationAlertPlayed = true;
      }
  }

  function playBellSound() {
      if (!meditationSoundEnabled) return;
       try {
           const AudioContext = window.AudioContext || window.webkitAudioContext;
           if (AudioContext) {
               const ctx = new AudioContext();
               const osc = ctx.createOscillator();
               const gain = ctx.createGain();
               osc.connect(gain);
               gain.connect(ctx.destination);
               osc.type = 'sine';
               osc.frequency.setValueAtTime(440, ctx.currentTime);
               gain.gain.setValueAtTime(0.1, ctx.currentTime);
               gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 1.5);
               osc.start();
               osc.stop(ctx.currentTime + 1.5);
           }
       } catch(e) {
           console.log("Audio play failed", e);
       }
  }

  function toggleMeditation() {
      const btn = document.getElementById('btn-timer-toggle');
      const iconPlay = document.getElementById('icon-play');
      const iconPause = document.getElementById('icon-pause');
      const status = document.getElementById('timer-status');

      if (meditationState === 'running') {
          // Pause
          clearInterval(meditationInterval);
          meditationState = 'paused';
          
          if (meditationStartTime) {
              meditationElapsedTime += Math.floor((Date.now() - meditationStartTime) / 1000);
          }
          meditationStartTime = null;

          iconPlay.classList.remove('hidden');
          iconPause.classList.add('hidden');
          btn.classList.remove('bg-[#b35c1e]');
          btn.classList.add('bg-amber-500');
          status.innerText = "å·²æš«åœ";
      } else {
          // Start
          meditationState = 'running';
          meditationStartTime = Date.now();
          
          iconPlay.classList.add('hidden');
          iconPause.classList.remove('hidden');
          btn.classList.add('bg-[#b35c1e]');
          btn.classList.remove('bg-amber-500');
          status.innerText = "ç¦ªä¿®ä¸­...";
          
          updateTimerDisplay();

          meditationInterval = setInterval(() => {
              updateTimerDisplay();
          }, 1000);
      }
  }

  function resetMeditation() {
      clearInterval(meditationInterval);
      
      meditationState = 'idle';
      meditationStartTime = null;
      meditationElapsedTime = 0;
      meditationAlertPlayed = false;
      
      updateTimerDisplay(); 
      
      const btn = document.getElementById('btn-timer-toggle');
      if(btn) {
          btn.classList.add('bg-[#b35c1e]');
          btn.classList.remove('bg-amber-500');
      }
      
      const iconPlay = document.getElementById('icon-play');
      if(iconPlay) iconPlay.classList.remove('hidden');
      
      const iconPause = document.getElementById('icon-pause');
      if(iconPause) iconPause.classList.add('hidden');
      
      const status = document.getElementById('timer-status');
      if(status) status.innerText = "æº–å‚™é–‹å§‹";
      
      // Reset progress circle
      const circle = document.getElementById('timer-progress');
      if (circle) {
           const circumference = 2 * Math.PI * 46;
           circle.style.strokeDashoffset = circumference;
      }
  }

  function toggleSound() {
      meditationSoundEnabled = !meditationSoundEnabled;
      const line = document.getElementById('sound-off-line');
      if (meditationSoundEnabled) {
          line.classList.add('hidden');
      } else {
          line.classList.remove('hidden');
      }
  }

  function manualSaveMeditation() {
      // Calculate total seconds
      let totalSeconds = meditationElapsedTime;
      if (meditationState === 'running' && meditationStartTime) {
          totalSeconds += Math.floor((Date.now() - meditationStartTime) / 1000);
      }
      
      if (totalSeconds < 60) {
          alert('æ‰“åæ™‚é–“ä¸è¶³ 1 åˆ†é˜ï¼Œä¸äºˆè¨˜éŒ„ã€‚');
          return;
      }
      
      if(!confirm('ç¢ºå®šè¦ä¿å­˜æ­¤æ¬¡ç¦ªä¿®è¨˜éŒ„ä¸¦æ­¸é›¶å—ï¼Ÿ')) return;
      
      const minutes = Math.floor(totalSeconds / 60);
      
      // Save Session Record
      const record = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          duration: totalSeconds, // Store seconds for precision if needed
          minutes: minutes
      };
      
      const history = JSON.parse(localStorage.getItem('meditation_session_history') || '[]');
      history.unshift(record);
      localStorage.setItem('meditation_session_history', JSON.stringify(history));
      
      // Also update daily total for statistics if needed (optional, but good for backward compat)
      const dailyHistory = JSON.parse(localStorage.getItem('meditation_history') || '{}');
      const k = new Date().toISOString().split('T')[0];
      dailyHistory[k] = (dailyHistory[k] || 0) + minutes;
      localStorage.setItem('meditation_history', JSON.stringify(dailyHistory));
      
      resetMeditation();
      renderMeditationHistory();
  }

  function renderMeditationHistory() {
      const historyEl = document.getElementById('meditation-history');
      if(!historyEl) return;
      
      const history = JSON.parse(localStorage.getItem('meditation_session_history') || '[]');
      
      if (history.length === 0) {
          historyEl.innerHTML = '<div class="text-center text-stone-400 py-6 text-xs bg-white/20 rounded-xl border border-white/30 backdrop-blur-sm">æš«ç„¡è¨˜éŒ„</div>';
          return;
      }
      
      let html = '<div class="space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">';
      history.forEach(rec => {
          const date = new Date(rec.timestamp);
          const dateStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
          const timeStr = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
          const durationStr = rec.minutes < 1 ? '<1 åˆ†' : `${rec.minutes} åˆ†`;
          
          html += `
            <div class="flex items-center justify-between text-xs py-2 px-3 bg-white/40 border border-white/50 rounded-lg backdrop-blur-sm hover:bg-white/60 transition-colors">
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-sm"></div>
                    <div class="text-stone-600">
                        <span class="font-bold mr-1 text-[#5c4033]">${dateStr}</span>
                        <span class="text-stone-400 font-mono text-[10px]">${timeStr}</span>
                    </div>
                </div>
                <div class="text-[#b35c1e] font-bold tabular-nums bg-[#b35c1e]/10 px-2 py-0.5 rounded-md border border-[#b35c1e]/20">${durationStr}</div>
            </div>
          `;
      });
      html += '</div>';
      
      historyEl.innerHTML = html;
  }

  // Dharma Logic
  function toggleDharmaSection(id) {
      const content = document.getElementById('content-' + id);
      const icon = document.getElementById('icon-' + id);
      if(content.classList.contains('hidden')) {
          content.classList.remove('hidden');
          icon.classList.add('rotate-180');
      } else {
          content.classList.add('hidden');
          icon.classList.remove('rotate-180');
      }
  }
  
  // Navigation Helper with Animation
  function navToReader(e, url) {
      e.preventDefault();
      const el = e.currentTarget;
      
      // Micro-animation: Scale down and Flash
      el.classList.add('scale-95', 'ring-2', 'ring-[#b35c1e]/30', 'bg-[#b35c1e]/10');
      
      // Wait for animation to be perceived (150ms)
      setTimeout(() => {
          window.location.href = url;
      }, 150);
  }

  function renderAudioList() {
      const list = document.getElementById('audio-list');
      if(!list || typeof audioData === 'undefined') return;

      list.innerHTML = audioData.map((audio, idx) => `
          <div onclick="openAudioModal(${idx})" class="mb-2 bg-white/40 backdrop-blur-md rounded-2xl p-3 shadow-sm border border-white/50 ring-1 ring-white/30 flex items-center gap-3 active:scale-[0.98] transition-all cursor-pointer hover:shadow-lg group">
              <div class="w-10 h-10 rounded-full bg-stone-100/80 backdrop-blur-sm flex items-center justify-center text-[#b35c1e] shrink-0 group-hover:bg-[#b35c1e] group-hover:text-white transition-colors shadow-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                      <path fill-rule="evenodd" d="M19.952 1.651a.75.75 0 01.298.599V16.303a3 3 0 01-2.176 2.884l-1.32.377a2.553 2.553 0 11-1.393-4.89l1.891-.54V6.111l-11.25 3.214v11.389a3 3 0 01-2.176 2.884l-1.32.377a2.553 2.553 0 11-1.393-4.89l1.891-.54V4.508a.75.75 0 01.956-.708l12-3.429a.75.75 0 01.8.28z" clip-rule="evenodd" />
                  </svg>
              </div>
              <div class="flex-1 min-w-0">
                  <div class="font-bold text-[#5c4033] text-sm truncate group-hover:text-[#b35c1e] transition-colors">${audio.title}</div>
                  <div class="text-xs text-stone-500 mt-0.5 opacity-80">MP3/WAV Audio</div>
              </div>
              <div class="text-stone-400/80">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112z" />
                  </svg>
              </div>
          </div>
      `).join('');
  }

  function openAudioModal(index) {
      const modal = document.getElementById('audio-modal');
      const titleEl = document.getElementById('audio-modal-title');
      const audioEl = document.getElementById('audio-player');
      
      if(!modal || !audioData[index]) return;
      
      const audio = audioData[index];
      
      // Set content
      if(titleEl) titleEl.innerText = audio.title;
      if(audioEl) {
          audioEl.onerror = () => {
              const err = audioEl.error;
              let msg = "æœªçŸ¥é”™è¯¯";
              if(err) {
                  switch(err.code) {
                      case 1: msg = "ç”¨æˆ·ç»ˆæ­¢"; break;
                      case 2: msg = "ç½‘ç»œé”™è¯¯"; break;
                      case 3: msg = "è§£ç é”™è¯¯"; break;
                      case 4: msg = "æºæ–‡ä»¶æ— æ³•è®¿é—®"; break;
                  }
              }
              alert(`æ— æ³•æ’­æ”¾éŸ³é¢‘: ${msg} (Code ${err ? err.code : '?'})\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚`);
          };
          audioEl.src = audio.url;
          audioEl.load(); // Reset state
          audioEl.play().catch(e => console.log('Auto-play prevented:', e));
      }
      
      // Show Modal
      modal.classList.remove('hidden');
  }

  function closeAudioModal() {
      const modal = document.getElementById('audio-modal');
      const audioEl = document.getElementById('audio-player');
      
      if(modal) modal.classList.add('hidden');
      if(audioEl) {
          audioEl.pause();
          audioEl.currentTime = 0;
          audioEl.src = ''; 
      }
  }

  function renderVideoList() {
      const list = document.getElementById('video-list');
      if(!list || typeof videoData === 'undefined') return;

      list.innerHTML = videoData.map((video, idx) => `
          <div onclick="openVideoModal(${idx})" class="mb-2 bg-white/40 backdrop-blur-md rounded-2xl p-3 shadow-sm border border-white/50 ring-1 ring-white/30 flex items-center gap-3 active:scale-[0.98] transition-all cursor-pointer hover:shadow-lg group">
              <div class="relative w-24 aspect-video bg-stone-100 rounded-lg overflow-hidden shrink-0 shadow-inner">
                  <div class="absolute inset-0 flex items-center justify-center text-red-500 bg-black/5 group-hover:bg-black/10 transition-colors">
                      <span class="text-xl drop-shadow-sm">â–¶ï¸</span>
                  </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-bold text-[#5c4033] text-sm line-clamp-2 group-hover:text-red-600 transition-colors" title="${video.title}">${video.title}</div>
                <div class="text-xs text-stone-500 mt-1 flex items-center gap-2 opacity-80">
                    <span>YouTube</span>
                    ${video.duration ? `<span>â€¢</span><span>${video.duration}</span>` : ''}
                </div>
            </div>
              <div class="text-stone-400/80">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112z" />
                  </svg>
              </div>
          </div>
      `).join('');
  }

  function openVideoModal(index) {
      const modal = document.getElementById('video-modal');
      const container = document.getElementById('video-modal-container');
      const warning = document.getElementById('video-modal-warning');
      const fallbackBtn = document.getElementById('video-fallback-btn');
      
      if(!modal || !container) return;
      
      // Show Modal
      modal.classList.remove('hidden');
      
      // Get Video Data
    const video = videoData[index];
    // Use direct video ID format (no playlist parameters)
    // Ensure we strip any potential parameters just in case
    const cleanId = video.videoId ? video.videoId.split('&')[0] : '';
    const src = `https://www.youtube.com/embed/${cleanId}`;
    
    container.innerHTML = `<iframe width="100%" height="100%" src="${src}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full rounded-xl shadow-2xl"></iframe>`;
    
    // Update Fallback Button
                if (fallbackBtn && video) {
                    if (video.videoId) {
                        fallbackBtn.href = `https://www.youtube.com/watch?v=${cleanId}`;
                    } else {
                        // Fallback if no videoId (should not happen based on data)
                        fallbackBtn.href = '#';
                    }
                    fallbackBtn.classList.remove('hidden');
                }

      // Check Network
      if(warning) {
          warning.classList.add('hidden');
          const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
          if (connection && connection.type && connection.type !== 'wifi' && connection.type !== 'ethernet' && connection.type !== 'none' && connection.type !== 'unknown') {
               warning.classList.remove('hidden');
          }
      }
  }

  function closeVideoModal() {
      const modal = document.getElementById('video-modal');
      const container = document.getElementById('video-modal-container');
      
      if(modal) modal.classList.add('hidden');
      if(container) container.innerHTML = ''; // Stop video
  }

  function renderDharma() {
      const list = document.getElementById('text-teachings-list');
      if(!list) return;
      
      const files = [
        { name: 'ä½›åˆ¶æˆ’å¾‹', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ä½›åˆ¶æˆ’å¾‹.txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬ä¸€é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬ä¸€é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬äºŒé ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬äºŒé .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬ä¸‰é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬ä¸‰é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬å››é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬å››é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬äº”é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬äº”é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬å…­é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬å…­é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬ä¸ƒé ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬ä¸ƒé .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬å…«é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬å…«é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬ä¹é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬ä¹é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åé ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åé .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åä¸€é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åä¸€é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åäºŒé ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åäºŒé .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åä¸‰é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åä¸‰é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åå››é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åå››é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åäº”é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åäº”é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åå…­é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åå…­é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åä¸ƒé ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åä¸ƒé .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åå…«é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åå…«é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬åä¹é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬åä¹é .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬äºŒåé ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬äºŒåé .txt' },
        { name: 'æ–‡å­—é–‹ç¤º ç¬¬äºŒåä¸€é ', file: 'è«¦æ·±å¤§å¸«_æ–‡å­—é–‹ç¤º_ç¬¬äºŒåä¸€é .txt' }
      ];

      list.innerHTML = files.map(f => `
        <a href="reader.html?file=${encodeURIComponent(f.file)}&title=${encodeURIComponent(f.name)}&from=sutras" 
           onclick="navToReader(event, this.href)"
           class="block px-4 py-3 mb-2 bg-white/40 backdrop-blur-sm hover:bg-white/60 hover:shadow-lg hover:-translate-y-0.5 hover:border-[#b35c1e]/30 transition-all duration-300 flex justify-between items-center group rounded-xl border border-white/50 active:scale-[0.98]">
            <span class="text-base font-bold text-[#5c4033] group-hover:text-[#b35c1e] transition-colors">${f.name}</span>
            <div class="w-6 h-6 rounded-full bg-white/50 flex items-center justify-center text-stone-400 group-hover:text-[#b35c1e] group-hover:bg-[#b35c1e]/10 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
            </div>
        </a>
      `).join('');
  }

  function renderSutras() {
      const list = document.getElementById('sutras-list');
      if(!list) return;

      const files = [
        { name: 'äº†è§£ä½›æ³•', file: 'äº†è§£ä½›æ³•----è°›æ·±å¤§å¸ˆå¼€ç¤º.txt' },
        { name: 'å¤§ä½›é ‚é¦–æ¥åš´ç¶“', file: 'å¤§ä½›é¡¶é¦–æ¥ä¸¥ç».txt' },
        { name: 'åœ°è—è©è–©æœ¬é¡˜ç¶“', file: 'åœ°è—è©è¨æœ¬æ„¿ç».txt' },
        { name: 'å¤§æ–¹å»£åœ“è¦ºä¿®å¤šç¾…äº†ç¾©ç¶“', file: 'å¤§æ–¹å¹¿åœ†è§‰ä¿®å¤šç½—äº†ä¹‰ç».txt' },
        { name: 'æ™®è³¢è©è–©è¡Œé¡˜å“', file: 'æ™®è´¤è©è¨è¡Œæ„¿å“.txt' },
        { name: 'è§€ä¸–éŸ³è©è–©æ™®é–€å“', file: 'è§‚ä¸–éŸ³è©è¨æ™®é—¨å“.txt' },
        { name: 'é‡‘å‰›èˆ¬è‹¥æ³¢ç¾…èœœç¶“', file: 'é‡‘åˆšèˆ¬è‹¥æ³¢ç½—èœœç».txt' }
      ];

      list.innerHTML = files.map(f => `
        <a href="reader.html?file=${encodeURIComponent(f.file)}&title=${encodeURIComponent(f.name)}" 
           onclick="navToReader(event, this.href)"
           class="block px-4 py-3 mb-2 bg-white/40 backdrop-blur-sm hover:bg-white/60 hover:shadow-lg hover:-translate-y-0.5 hover:border-[#b35c1e]/30 transition-all duration-300 flex justify-between items-center group rounded-xl border border-white/50 active:scale-[0.98]">
            <span class="text-base font-bold text-[#5c4033] group-hover:text-[#b35c1e] transition-colors">${f.name}</span>
            <div class="w-6 h-6 rounded-full bg-white/50 flex items-center justify-center text-stone-400 group-hover:text-[#b35c1e] group-hover:bg-[#b35c1e]/10 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
            </div>
        </a>
      `).join('');
  }

  function renderMasters() {
      const list = document.getElementById('masters-list');
      if(!list) return;

      const files = [
        { name: 'å½±å°˜å›å¿†å½•ä¸Š', file: 'ç¥–å¸ˆå¤§å¾·/å½±å°˜å›å¿†å½•ä¸Š.txt' },
        { name: 'å½±å°˜å›å¿†å½•ä¸‹', file: 'ç¥–å¸ˆå¤§å¾·/å½±å°˜å›å¿†å½•ä¸‹.txt' },
        { name: 'è™šäº‘è€å’Œå°šå¹´è°±', file: 'ç¥–å¸ˆå¤§å¾·/è™šäº‘è€å’Œå°šå¹´è°±.txt' }
      ];

      list.innerHTML = files.map(f => `
        <a href="reader.html?file=${encodeURIComponent(f.file)}&title=${encodeURIComponent(f.name)}" 
           onclick="navToReader(event, this.href)"
           class="block px-4 py-3 mb-2 bg-white/40 backdrop-blur-sm hover:bg-white/60 hover:shadow-lg hover:-translate-y-0.5 hover:border-[#b35c1e]/30 transition-all duration-300 flex justify-between items-center group rounded-xl border border-white/50 active:scale-[0.98]">
            <span class="text-base font-bold text-[#5c4033] group-hover:text-[#b35c1e] transition-colors">${f.name}</span>
            <div class="w-6 h-6 rounded-full bg-white/50 flex items-center justify-center text-stone-400 group-hover:text-[#b35c1e] group-hover:bg-[#b35c1e]/10 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
            </div>
        </a>
      `).join('');
  }

  // Initialization
  renderCalendar();
  initCounter();
  renderMeditationHistory();
  renderDharma();
  renderVideoList();
  renderAudioList();
  renderSutras();
  renderMasters();
  
  // Set default today info
  (function initToday() {
    renderDayInfo(today.getFullYear(), today.getMonth() + 1, today.getDate());
  })();

  // Check if returning from reader (Dharma Sutras or Search)
  function checkDharmaState() {
      const dharmaState = localStorage.getItem('dharma_tab_state');
      const hash = window.location.hash;
      
      if (hash === '#search') {
          setTimeout(() => {
              switchTab('search');
              try {
                history.replaceState(null, null, window.location.pathname + window.location.search);
              } catch(e) {}
          }, 100);
          return;
      }

      if (dharmaState === 'sutras' || hash === '#dharma_sutras') {
          // Delay slightly to ensure DOM is ready and override default state
          setTimeout(() => {
              switchTab('dharma');
              // Expand Sutras section
              const content = document.getElementById('content-sutras');
              const icon = document.getElementById('icon-sutras');
              if (content && content.classList.contains('hidden')) {
                  content.classList.remove('hidden');
                  if(icon) icon.classList.add('rotate-180');
              }
              // Scroll to sutras section if needed, or just let it be at top
              if (content) {
                  // Optional: content.scrollIntoView({ behavior: 'smooth' });
              }

              // Clear state
              localStorage.removeItem('dharma_tab_state');
              if (hash === '#dharma_sutras') {
                  try {
                    history.replaceState(null, null, window.location.pathname + window.location.search);
                  } catch(e) {
                    // Ignore if file:// protocol restricts history API
                  }
              }
          }, 100);
      }
  }

  // Handle page show (includes back/forward cache)
  window.addEventListener('pageshow', checkDharmaState);
  // Also run on initial load just in case
  checkDharmaState();

  // Initialize i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (key) el.innerText = t(key);
  });

</script>
<!-- Video Modal -->
<!-- Audio Modal -->
<div id="audio-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-stone-900/90 backdrop-blur-sm transition-opacity" onclick="closeAudioModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <!-- Header -->
                <div class="bg-[#f7f5f2] px-4 py-3 border-b border-[#ede9e3] flex justify-between items-center">
                    <h3 class="text-base font-bold text-[#5c4033] truncate pr-4" id="audio-modal-title">Audio Title</h3>
                    <button type="button" class="text-stone-400 hover:text-stone-600 focus:outline-none" onclick="closeAudioModal()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <!-- Content -->
                <div class="p-6 flex flex-col items-center gap-6">
                    <div class="w-24 h-24 bg-[#f7f5f2] rounded-full flex items-center justify-center text-[#b35c1e] shadow-inner">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12">
                            <path fill-rule="evenodd" d="M19.952 1.651a.75.75 0 01.298.599V16.303a3 3 0 01-2.176 2.884l-1.32.377a2.553 2.553 0 11-1.393-4.89l1.891-.54V6.111l-11.25 3.214v11.389a3 3 0 01-2.176 2.884l-1.32.377a2.553 2.553 0 11-1.393-4.89l1.891-.54V4.508a.75.75 0 01.956-.708l12-3.429a.75.75 0 01.8.28z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <audio id="audio-player" controls class="w-full h-12 rounded-lg bg-[#f7f5f2] text-[#b35c1e]">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Video Modal -->
    <div id="video-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-stone-900/90 backdrop-blur-sm transition-opacity" onclick="closeVideoModal()"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <!-- Modal Panel -->
                <div class="relative transform overflow-hidden rounded-2xl bg-black shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl aspect-video w-full">
                    
                    <!-- Close Button -->
                    <button type="button" class="absolute top-4 right-4 z-20 text-white/70 hover:text-white bg-black/50 hover:bg-black/70 rounded-full p-2 transition-colors" onclick="closeVideoModal()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>

                    <!-- Video Container -->
                    <div id="video-modal-container" class="w-full h-full bg-black flex items-center justify-center">
                        <!-- IFrame will be injected here -->
                    </div>
                    
                    <!-- Network Warning -->
                    <div id="video-modal-warning" class="absolute bottom-4 left-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 rounded shadow-lg hidden z-20 flex justify-between items-center text-sm">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            <span data-i18n="video_mobile_warning">å½“å‰ä¸ºç§»åŠ¨ç½‘ç»œï¼Œè¯·æ³¨æ„æµé‡æ¶ˆè€—</span>
                        </div>
                        <button onclick="this.parentElement.classList.add('hidden')" class="text-yellow-700 hover:text-yellow-900 font-bold px-2">âœ•</button>
                    </div>

                    <!-- External Link Fallback -->
                    <a id="video-fallback-btn" href="#" target="_blank" class="hidden absolute bottom-4 right-4 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-full backdrop-blur-md text-sm font-medium transition-colors flex items-center gap-2">
                        <span data-i18n="video_watch_youtube">åœ¨ YouTube è§‚çœ‹</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center text-[10px] text-stone-300 py-4 opacity-50">App Version: v19.1</div>

    <script>
      function applyTranslations() {
        if (typeof t !== 'function') return;
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          const translation = t(key);
          if (translation) {
            if (el.hasAttribute('data-i18n-html')) {
              el.innerHTML = translation;
            } else {
              el.innerText = translation;
            }
          }
        });
        
        // Update placeholders
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            const translation = t(key);
            if(translation) {
                el.placeholder = translation;
            }
        });
      }

      // Initial call
      document.addEventListener('DOMContentLoaded', () => {
          applyTranslations();
      });
    </script>

    <script>
      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(registration => {
              console.log('SW registered:', registration);
              // Check for updates every time page loads
              registration.update();
              
              registration.onupdatefound = () => {
                const newWorker = registration.installing;
                newWorker.onstatechange = () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        console.log('New update available');
                    }
                };
              };
            })
            .catch(error => {
              console.log('SW registration failed:', error);
            });
            
            // Auto-reload when new SW takes control
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('New version activated, reloading...');
                window.location.reload();
            });
        });
      }
    </script>
  <script>
    // Special events functionality
    function showTooltip(event, text) {
      const tooltip = document.getElementById('event-tooltip');
      if (!tooltip) return;
      tooltip.textContent = text;
      tooltip.style.display = 'block';
      const x = event.clientX + 15;
      const y = event.clientY + 15;
      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    }

    function hideTooltip() {
      const tooltip = document.getElementById('event-tooltip');
      if (!tooltip) return;
      tooltip.style.display = 'none';
    }

    // Override existing renderCalendar function
    const originalRenderCalendar = window.renderCalendar;
    window.renderCalendar = function(date) {
      const calendarGrid = document.getElementById('calendar-grid');
      const calendarHeader = document.getElementById('calendar-header');
      const weekdayHeader = document.getElementById('weekday-header');
      if (!calendarGrid || !calendarHeader || !weekdayHeader) {
        // If elements don't exist, fallback to original function if it exists
        if(originalRenderCalendar) originalRenderCalendar(date);
        return;
      }

      const year = date.getFullYear();
      const month = date.getMonth();

      const monthName = i18n.t('months')[month];
      calendarHeader.textContent = `${year} ${monthName}`;

      weekdayHeader.innerHTML = '';
      const weekdays = i18n.t('weekdays_short');
      weekdays.forEach(day => {
        const dayEl = document.createElement('div');
        dayEl.textContent = day;
        weekdayHeader.appendChild(dayEl);
      });

      calendarGrid.innerHTML = '';
      const firstDayOfMonth = new Date(year, month, 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const firstDayOfWeek = (firstDayOfMonth.getDay() === 0 && getWeekStart() === 'monday') ? 6 : (firstDayOfMonth.getDay() + (getWeekStart() === 'monday' ? -1 : 0) + 7) % 7;

      for (let i = 0; i < 42; i++) {
        const day = i - firstDayOfWeek + 1;
        const currentDate = new Date(year, month, day);
        const cell = document.createElement('div');
        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();

        if (day > 0 && day <= daysInMonth) {
          const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const specialEvent = window.specialEvents && window.specialEvents.find(e => e.date === dateString);

          const lunarDate = Lunar.solar2lunar(year, month + 1, day);
          let dayStr = `<div class="text-sm lg:text-base font-medium">${day}</div>`;
          let lunarStr;
          if (lunarDate.term) {
            lunarStr = `<div class="text-[10px] lg:text-xs opacity-70 font-bold text-emerald-600">${lunarDate.term}</div>`;
          } else if (lunarDate.isLeap) {
            lunarStr = `<div class="text-[10px] lg:text-xs opacity-70">é—°${lunarDate.monthStr}${lunarDate.dayStr}</div>`;
          } else if (lunarDate.day === 1) {
            lunarStr = `<div class="text-[10px] lg:text-xs opacity-70">${lunarDate.monthStr}</div>`;
          } else {
            lunarStr = `<div class="text-[10px] lg:text-xs opacity-70">${lunarDate.dayStr}</div>`;
          }
          
          cell.innerHTML = dayStr + lunarStr;
          cell.className = 'relative text-center py-1.5 rounded-lg transition-all duration-200 cursor-pointer ';

          if (isToday) {
            cell.className += 'bg-[#8B4513] text-white shadow-lg ring-2 ring-white/50';
          } else {
            cell.className += 'hover:bg-white/50 active:scale-95';
          }

          if (specialEvent) {
              cell.classList.add(`event-${specialEvent.type}`);
              cell.setAttribute('onmouseover', `showTooltip(event, '${specialEvent.description}')`);
              cell.setAttribute('onmouseout', 'hideTooltip()');
          }
          
          cell.onclick = () => {
            currentDisplayDate = currentDate;
            updateDayInfo(currentDate);
            document.querySelectorAll('#calendar-grid > div').forEach(c => {
                c.classList.remove('bg-[#b35c1e]', 'text-white', 'shadow-md');
                if (!c.classList.contains('bg-[#8B4513]')) {
                   c.classList.add('hover:bg-white/50', 'active:scale-95');
                }
            });
            if (!isToday) {
               cell.classList.add('bg-[#b35c1e]', 'text-white', 'shadow-md');
               cell.classList.remove('hover:bg-white/50', 'active:scale-95');
            }
          };
        } else {
          cell.className = 'text-center py-2 rounded-lg text-transparent';
          cell.innerHTML = `<div>0</div><div class="text-xs"></div>`;
        }
        calendarGrid.appendChild(cell);
      }
      applySpecialEvents(year, month);
    }  // Re-select the currently displayed day after re-render
      if(window.updateDayInfo) updateDayInfo(currentDisplayDate);
    }

    // Ensure the script runs after the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof currentDisplayDate !== 'undefined') {
        renderCalendar(currentDisplayDate);
      }
    });
  </script>
</body>
</html>
